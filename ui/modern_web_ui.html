<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ğŸ˜ï¸ AIè™šæ‹Ÿå°é•‡ - æ™ºèƒ½äº¤äº’ç‰ˆ</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --secondary: #8b5cf6;
            --accent: #06b6d4;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --bg-primary: #0f0f23;
            --bg-secondary: #1a1a2e;
            --bg-card: #16213e;
            --text-primary: #ffffff;
            --text-secondary: #a0a9c0;
            --border: #2d3748;
            --shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            --glass: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
        }

        [data-theme="light"] {
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-card: #ffffff;
            --text-primary: #1a202c;
            --text-secondary: #4a5568;
            --border: #e2e8f0;
            --glass: rgba(0, 0, 0, 0.05);
            --glass-border: rgba(0, 0, 0, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* åŠ¨æ€èƒŒæ™¯ */
        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: linear-gradient(-45deg, #6366f1, #8b5cf6, #06b6d4, #10b981);
            background-size: 400% 400%;
            animation: gradientShift 15s ease infinite;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* ç²’å­æ•ˆæœ */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
        }

        .particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            animation: float 20s infinite linear;
        }

        @keyframes float {
            0% { transform: translateY(100vh) rotate(0deg); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-100vh) rotate(360deg); opacity: 0; }
        }

        /* ç»ç’ƒå½¢æ€å®¹å™¨ */
        .glass-container {
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            box-shadow: var(--shadow);
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }

        /* é¡¶éƒ¨å¯¼èˆª */
        .navbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            margin-bottom: 30px;
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            position: sticky;
            top: 20px;
            z-index: 100;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.5rem;
            font-weight: 700;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-controls {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .theme-toggle {
            background: var(--glass);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-primary);
        }

        .theme-toggle:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .status-bar {
            display: flex;
            gap: 20px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.2); }
        }

        /* ä¸»è¦å†…å®¹åŒº */
        .main-content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 30px;
            min-height: 800px;
        }

        .content-area {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        /* 3Dåœ°å›¾åŒºåŸŸ */
        .map-section {
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 24px;
            padding: 30px;
            position: relative;
            overflow: hidden;
        }

        .map-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .map-title {
            font-size: 1.8rem;
            font-weight: 600;
            background: linear-gradient(135deg, var(--primary), var(--accent));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .map-controls {
            display: flex;
            gap: 10px;
        }

        .map-btn {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 8px 16px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .map-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(99, 102, 241, 0.3);
        }

        /* 3Dåœ°å›¾ç½‘æ ¼ */
        .map-container {
            perspective: 1000px;
            display: flex;
            justify-content: center;
            margin: 20px 0;
        }

        .map-grid {
            display: grid;
            grid-template-columns: repeat(6, 80px);
            grid-template-rows: repeat(6, 80px);
            gap: 8px;
            transform: rotateX(15deg) rotateY(5deg);
            transition: transform 0.3s ease;
        }

        .map-grid:hover {
            transform: rotateX(10deg) rotateY(0deg);
        }

        .map-cell {
            background: linear-gradient(145deg, var(--bg-card), var(--bg-secondary));
            border: 2px solid var(--border);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .map-cell::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, transparent, rgba(255, 255, 255, 0.1));
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .map-cell:hover::before {
            opacity: 1;
        }

        .map-cell:hover {
            transform: translateZ(20px) rotateX(-5deg);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        .map-cell.building {
            background: linear-gradient(145deg, var(--primary), var(--secondary));
            color: white;
            border-color: var(--primary);
        }

        .map-cell.agent {
            background: linear-gradient(145deg, var(--success), var(--accent));
            color: white;
            border-color: var(--success);
            animation: agentPulse 3s infinite;
        }

        @keyframes agentPulse {
            0%, 100% { box-shadow: 0 0 20px var(--success); }
            50% { box-shadow: 0 0 40px var(--success), 0 0 60px var(--success); }
        }

        /* å³ä¾§é¢æ¿ */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .panel {
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 25px;
            transition: transform 0.3s ease;
        }

        .panel:hover {
            transform: translateY(-5px);
        }

        .panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }

        .panel-title {
            font-size: 1.2rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Agentå¡ç‰‡ */
        .agents-grid {
            display: grid;
            gap: 15px;
            max-height: 400px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .agents-grid::-webkit-scrollbar {
            width: 6px;
        }

        .agents-grid::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 3px;
        }

        .agents-grid::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 3px;
        }

        .agent-card {
            background: linear-gradient(135deg, var(--bg-card), var(--bg-secondary));
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .agent-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--primary), var(--secondary));
        }

        .agent-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.2);
            border-color: var(--primary);
        }

        .agent-card.selected {
            border-color: var(--primary);
            box-shadow: 0 0 30px rgba(99, 102, 241, 0.3);
        }

        .agent-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 15px;
        }

        .agent-avatar {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .agent-info h4 {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .agent-info p {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .agent-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            margin-top: 15px;
        }

        .stat-item {
            background: var(--bg-primary);
            border-radius: 8px;
            padding: 8px 12px;
            font-size: 0.85rem;
            text-align: center;
        }

        .energy-bar {
            width: 100%;
            height: 6px;
            background: var(--bg-primary);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 8px;
        }

        .energy-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success), var(--warning));
            border-radius: 3px;
            transition: width 1s ease;
        }

        /* èŠå¤©åŒºåŸŸ */
        .chat-container {
            background: var(--bg-card);
            border-radius: 16px;
            height: 400px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 15px 20px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: var(--bg-primary);
            border-radius: 3px;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 3px;
        }

        .message {
            display: flex;
            gap: 12px;
            animation: messageSlide 0.3s ease;
            align-items: flex-start;
        }

        @keyframes messageSlide {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            flex-direction: row-reverse;
        }

        .message-avatar {
            width: 35px;
            height: 35px;
            border-radius: 8px;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            flex-shrink: 0;
        }

        .message-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 12px 16px;
            max-width: 70%;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .message.user .message-content {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-color: var(--primary);
        }

        .chat-input {
            display: flex;
            padding: 15px 20px;
            gap: 10px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
        }

        .chat-input input {
            flex: 1;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 12px 16px;
            color: var(--text-primary);
            font-size: 0.9rem;
            outline: none;
            transition: border-color 0.3s ease;
        }

        .chat-input input:focus {
            border-color: var(--primary);
        }

        .chat-input button {
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 12px 20px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .chat-input button:hover {
            background: var(--primary-dark);
            transform: translateY(-1px);
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 1200px) {
            .main-content {
                grid-template-columns: 1fr;
                gap: 20px;
            }
            
            .sidebar {
                flex-direction: row;
                overflow-x: auto;
            }
            
            .panel {
                min-width: 300px;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .navbar {
                padding: 15px 20px;
                flex-wrap: wrap;
                gap: 15px;
            }
            
            .map-grid {
                grid-template-columns: repeat(6, 60px);
                grid-template-rows: repeat(6, 60px);
                gap: 4px;
            }
            
            .map-cell {
                font-size: 1.4rem;
            }
            
            .sidebar {
                flex-direction: column;
            }
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* å·¥å…·æç¤º */
        .tooltip {
            position: relative;
            cursor: help;
        }

        .tooltip::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background: var(--bg-card);
            color: var(--text-primary);
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 0.8rem;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            border: 1px solid var(--border);
        }

        .tooltip:hover::after {
            opacity: 1;
            visibility: visible;
        }

        /* å¿«é€Ÿæ“ä½œæŒ‰é’® */
        .quick-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .quick-btn {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 6px 12px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--text-secondary);
        }

        .quick-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        /* é€šçŸ¥ç³»ç»Ÿ */
        .notification {
            position: fixed;
            top: 100px;
            right: 20px;
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 15px 20px;
            color: var(--text-primary);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1000;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            border-left: 4px solid var(--success);
        }

        .notification.error {
            border-left: 4px solid var(--error);
        }

        .notification.warning {
            border-left: 4px solid var(--warning);
        }

        /* Agentäº¤äº’é¢æ¿æ ·å¼ */
        .interaction-feed {
            max-height: 300px;
            overflow-y: auto;
            padding-right: 10px;
        }

        .interaction-feed::-webkit-scrollbar {
            width: 6px;
        }

        .interaction-feed::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 3px;
        }

        .interaction-feed::-webkit-scrollbar-thumb {
            background: var(--primary);
            border-radius: 3px;
        }

        .interaction-item {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 12px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .interaction-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .interaction-content {
            font-size: 0.9rem;
            line-height: 1.4;
            margin-bottom: 8px;
        }

        .interaction-participants {
            display: flex;
            gap: 4px;
            flex-wrap: wrap;
        }

        .participant-tag {
            background: var(--primary);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .social-network-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            z-index: 1000;
            display: none;
            align-items: center;
            justify-content: center;
        }

        .social-network-modal.show {
            display: flex;
        }

        .modal-content {
            background: var(--glass);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 20px;
            padding: 30px;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            width: 90%;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-close {
            background: var(--error);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
            font-weight: 500;
        }

        .relationship-grid {
            display: grid;
            gap: 15px;
        }

        .relationship-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 15px;
        }

        .relationship-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .relationship-strength {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8rem;
        }

        .strength-bar {
            width: 60px;
            height: 4px;
            background: var(--bg-primary);
            border-radius: 2px;
            overflow: hidden;
        }

        .strength-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--error), var(--warning), var(--success));
            border-radius: 2px;
            transition: width 0.3s ease;
        }
    </style>
</head>
<body data-theme="dark">
    <!-- åŠ¨æ€èƒŒæ™¯ -->
    <div class="bg-animation"></div>
    <div class="particles" id="particles"></div>

    <div class="container">
        <!-- å¯¼èˆªæ  -->
        <nav class="navbar">
            <div class="logo">
                <i class="fas fa-city"></i>
                <span>AIè™šæ‹Ÿå°é•‡</span>
                <span style="font-size: 0.8rem; opacity: 0.7;">v3.0</span>
            </div>
            
            <div class="nav-controls">
                <div class="status-bar">
                    <div class="status-item">
                        <div class="status-dot"></div>
                        <span>AIç³»ç»Ÿåœ¨çº¿</span>
                    </div>
                    <div class="status-item">
                        <i class="fas fa-users"></i>
                        <span id="agentCount">9ä¸ªAgent</span>
                    </div>
                    <div class="status-item">
                        <i class="fas fa-building"></i>
                        <span>8ä¸ªå»ºç­‘</span>
                    </div>
                </div>
                
                <button class="theme-toggle" onclick="toggleTheme()">
                    <i class="fas fa-moon" id="themeIcon"></i>
                </button>
            </div>
        </nav>

        <!-- ä¸»è¦å†…å®¹ -->
        <div class="main-content">
            <div class="content-area">
                <!-- 3Dåœ°å›¾åŒºåŸŸ -->
                <section class="map-section">
                    <div class="map-header">
                        <h2 class="map-title">
                            <i class="fas fa-map"></i>
                            æ™ºèƒ½å°é•‡3Dåœ°å›¾
                        </h2>
                        <div class="map-controls">
                            <button class="map-btn" onclick="refreshMap()">
                                <i class="fas fa-sync-alt"></i>
                                åˆ·æ–°
                            </button>
                            <button class="map-btn" onclick="simulateStep()">
                                <i class="fas fa-play"></i>
                                æ¨¡æ‹Ÿ
                            </button>
                            <button class="map-btn" onclick="triggerAgentInteraction()">
                                <i class="fas fa-users"></i>
                                äº’åŠ¨
                            </button>
                            <button class="map-btn" onclick="showSocialNetwork()">
                                <i class="fas fa-network-wired"></i>
                                ç¤¾äº¤ç½‘ç»œ
                            </button>
                            <button class="map-btn" onclick="showAdvancedStats()">
                                <i class="fas fa-chart-line"></i>
                                é«˜çº§ç»Ÿè®¡
                            </button>
                            <button class="map-btn" onclick="intelligentGroupMovement(); generateMap(); generateAgentCards();">
                                <i class="fas fa-route"></i>
                                æ™ºèƒ½ç§»åŠ¨
                            </button>
                        </div>
                    </div>
                    
                    <div class="map-container">
                        <div class="map-grid" id="mapGrid">
                            <!-- åœ°å›¾æ ¼å­å°†ç”±JavaScriptç”Ÿæˆ -->
                        </div>
                    </div>
                    
                    <div id="simulationOutput" style="margin-top: 20px; padding: 15px; background: var(--bg-card); border-radius: 12px; border: 1px solid var(--border); font-family: 'JetBrains Mono', monospace; font-size: 0.9rem; min-height: 80px; color: var(--text-secondary);"></div>
                </section>
            </div>

            <!-- å³ä¾§é¢æ¿ -->
            <aside class="sidebar">
                <!-- Agentæ§åˆ¶é¢æ¿ -->
                <div class="panel">
                    <div class="panel-header">
                        <h3 class="panel-title">
                            <i class="fas fa-robot"></i>
                            æ™ºèƒ½Agent
                        </h3>
                        <span class="tooltip" data-tooltip="ç‚¹å‡»Agentå¡ç‰‡é€‰æ‹©å¯¹è¯å¯¹è±¡">
                            <i class="fas fa-info-circle"></i>
                        </span>
                    </div>
                    
                    <div class="agents-grid" id="agentsGrid">
                        <!-- Agentå¡ç‰‡å°†ç”±JavaScriptç”Ÿæˆ -->
                    </div>
                    
                    <div class="quick-actions">
                        <button class="quick-btn" onclick="randomizeAgents()">
                            <i class="fas fa-random"></i>
                            éšæœºç§»åŠ¨
                        </button>
                        <button class="quick-btn" onclick="resetAgents()">
                            <i class="fas fa-home"></i>
                            å›åˆ°åˆå§‹ä½ç½®
                        </button>
                        <button class="quick-btn" onclick="toggleAutoInteraction()">
                            <i class="fas fa-robot"></i>
                            <span id="autoInteractionText">è‡ªåŠ¨äº¤äº’</span>
                        </button>
                        <button class="quick-btn" onclick="exportGameData()">
                            <i class="fas fa-download"></i>
                            å¯¼å‡ºæ•°æ®
                        </button>
                        <button class="quick-btn" onclick="resetGameData()">
                            <i class="fas fa-trash"></i>
                            é‡ç½®æ•°æ®
                        </button>
                        <button class="quick-btn" onclick="showDecayInfo()">
                            <i class="fas fa-heart"></i>
                            è¡°å‡ä¿¡æ¯
                        </button>
                    </div>
                </div>

                <!-- Agenté—´äº¤äº’é¢æ¿ -->
                <div class="panel">
                    <div class="panel-header">
                        <h3 class="panel-title">
                            <i class="fas fa-comments"></i>
                            Agentäº¤äº’è®°å½•
                        </h3>
                        <button class="quick-btn" onclick="clearInteractionHistory()">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    
                    <div class="interaction-feed" id="interactionFeed">
                        <div style="text-align: center; color: var(--text-secondary); padding: 20px;">
                            <i class="fas fa-users" style="font-size: 2rem; margin-bottom: 10px; opacity: 0.3;"></i>
                            <p>ç­‰å¾…Agenté—´çš„äº¤äº’...</p>
                        </div>
                    </div>
                    
                    <div class="quick-actions">
                        <button class="quick-btn" onclick="organizeGroupActivity()">
                            <i class="fas fa-calendar"></i>
                            ç»„ç»‡æ´»åŠ¨
                        </button>
                        <button class="quick-btn" onclick="showLocationStats()">
                            <i class="fas fa-chart-bar"></i>
                            åœ°ç‚¹ç»Ÿè®¡
                        </button>
                    </div>
                </div>

                <!-- èŠå¤©é¢æ¿ -->
                <div class="panel">
                    <div class="panel-header">
                        <h3 class="panel-title">
                            <i class="fas fa-comments"></i>
                            æ™ºèƒ½å¯¹è¯
                        </h3>
                        <button class="quick-btn" onclick="clearChat()">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    
                    <div class="chat-container">
                        <div class="chat-header">
                            <i class="fas fa-robot"></i>
                            <span id="chatTitle">é€‰æ‹©Agentå¼€å§‹å¯¹è¯</span>
                        </div>
                        
                        <div class="chat-messages" id="chatMessages">
                            <div style="text-align: center; color: var(--text-secondary); margin: auto;">
                                <i class="fas fa-comments" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.3;"></i>
                                <p>ç‚¹å‡»ä¸Šæ–¹Agentå¡ç‰‡å¼€å§‹å¯¹è¯</p>
                                <p style="font-size: 0.8rem; margin-top: 10px;">AIå°†æ ¹æ®Agentçš„æ€§æ ¼ç‰¹ç‚¹è¿›è¡Œå›åº”</p>
                            </div>
                        </div>
                        
                        <div class="chat-input">
                            <input type="text" id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯..." disabled>
                            <button onclick="sendMessage()" disabled id="sendBtn">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="quick-actions">
                        <button class="quick-btn" onclick="quickMessage('ä½ å¥½ï¼')">ğŸ‘‹ æ‰“æ‹›å‘¼</button>
                        <button class="quick-btn" onclick="quickMessage('æœ€è¿‘æ€ä¹ˆæ ·ï¼Ÿ')">â“ è¯¢é—®è¿‘å†µ</button>
                        <button class="quick-btn" onclick="quickMessage('èŠèŠå·¥ä½œ')">ğŸ’¼ è°ˆè®ºå·¥ä½œ</button>
                        <button class="quick-btn" onclick="quickMessage('ä»Šå¤©è®¡åˆ’')">ğŸ“… è¯¢é—®è®¡åˆ’</button>
                    </div>
                </div>
            </aside>
        </div>
    </div>

    <!-- é€šçŸ¥å®¹å™¨ -->
    <div id="notification" class="notification"></div>

    <!-- ç¤¾äº¤ç½‘ç»œæ¨¡æ€æ¡† -->
    <div id="socialNetworkModal" class="social-network-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="margin: 0; display: flex; align-items: center; gap: 10px;">
                    <i class="fas fa-network-wired"></i>
                    ç¤¾äº¤ç½‘ç»œåˆ†æ
                </h2>
                <button class="modal-close" onclick="closeSocialNetwork()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="socialNetworkContent">
                <!-- ç¤¾äº¤ç½‘ç»œå†…å®¹å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <script>
        // æ¸¸æˆæ•°æ® - å¢å¼ºç‰ˆæœ¬ï¼Œæ”¯æŒagenté—´äº¤äº’
        const gameData = {
            buildings: [
                {name: 'å’–å•¡å…', emoji: 'â˜•', x: 1, y: 3, description: 'æ¸©é¦¨çš„å’–å•¡å…'},
                {name: 'å›¾ä¹¦é¦†', emoji: 'ğŸ“š', x: 4, y: 3, description: 'å®‰é™çš„é˜…è¯»ç©ºé—´'},
                {name: 'å…¬å›­', emoji: 'ğŸŒ³', x: 2, y: 1, description: 'ç»¿è‰²çš„ä¼‘é—²åŒº'},
                {name: 'åŠå…¬å®¤', emoji: 'ğŸ’¼', x: 5, y: 1, description: 'é«˜æ•ˆçš„å·¥ä½œåœºæ‰€'},
                {name: 'å®¶', emoji: 'ğŸ ', x: 3, y: 5, description: 'æ¸©æš–çš„å®¶'},
                {name: 'åŒ»é™¢', emoji: 'ğŸ¥', x: 0, y: 2, description: 'åŒ»ç–—ä¸­å¿ƒ'},
                {name: 'é¤å…', emoji: 'ğŸ½ï¸', x: 5, y: 4, description: 'ç¾é£Ÿå¤©åœ°'},
                {name: 'ä¿®ç†åº—', emoji: 'ğŸ”§', x: 1, y: 0, description: 'ç»´ä¿®å·¥åŠ'}
            ],
            agents: {
                'Alex': {
                    emoji: 'ğŸ‘¨â€ğŸ’»', 
                    occupation: 'ç¨‹åºå‘˜', 
                    location: 'åŠå…¬å®¤', 
                    x: 5, y: 1, 
                    energy: 85, 
                    mood: 'ä¸“æ³¨', 
                    personality: 'é€»è¾‘æ€ç»´å¼ºï¼Œå–œæ¬¢è§£å†³æŠ€æœ¯é—®é¢˜',
                    background: 'è®¡ç®—æœºç§‘å­¦ä¸“ä¸šï¼Œçƒ­çˆ±ç¼–ç¨‹å’Œç®—æ³•',
                    expertise: ['ç¼–ç¨‹', 'ç®—æ³•', 'æŠ€æœ¯å­¦ä¹ ', 'é—®é¢˜è§£å†³'],
                    preferences: ['å’–å•¡å…', 'åŠå…¬å®¤', 'å›¾ä¹¦é¦†'],
                    relationships: {}, 
                    lastInteraction: null,
                    memories: [],
                    currentThoughts: ''
                },
                'Emma': {
                    emoji: 'ğŸ‘©â€ğŸ¨', 
                    occupation: 'è‰ºæœ¯å®¶', 
                    location: 'å…¬å›­', 
                    x: 2, y: 1, 
                    energy: 90, 
                    mood: 'åˆ›ä½œä¸­', 
                    personality: 'å¯Œæœ‰åˆ›é€ åŠ›ï¼Œæ„Ÿæ€§ä¸°å¯Œ',
                    background: 'è‰ºæœ¯å­¦é™¢æ¯•ä¸šï¼Œæ“…é•¿ç»˜ç”»å’Œè®¾è®¡',
                    expertise: ['è‰ºæœ¯åˆ›ä½œ', 'è‰²å½©è®¾è®¡', 'ç¾å­¦æ„ŸçŸ¥', 'åˆ›æ„è¡¨è¾¾'],
                    preferences: ['å…¬å›­', 'å®¶', 'å’–å•¡å…'],
                    relationships: {}, 
                    lastInteraction: null,
                    memories: [],
                    currentThoughts: ''
                },
                'Sarah': {
                    emoji: 'ğŸ‘©â€ğŸ«', 
                    occupation: 'æ•™å¸ˆ', 
                    location: 'å›¾ä¹¦é¦†', 
                    x: 4, y: 3, 
                    energy: 75, 
                    mood: 'å¼€å¿ƒ', 
                    personality: 'è€å¿ƒå‹å–„ï¼Œå–„äºæ²Ÿé€š',
                    background: 'æ•™è‚²å­¦ä¸“ä¸šï¼Œæœ‰å¤šå¹´æ•™å­¦ç»éªŒ',
                    expertise: ['æ•™è‚²', 'çŸ¥è¯†åˆ†äº«', 'å­¦ä¹ æŒ‡å¯¼', 'æ²Ÿé€šæŠ€å·§'],
                    preferences: ['å›¾ä¹¦é¦†', 'å’–å•¡å…', 'å…¬å›­'],
                    relationships: {}, 
                    lastInteraction: null,
                    memories: [],
                    currentThoughts: ''
                },
                'David': {
                    emoji: 'ğŸ‘¨â€ğŸ’¼', 
                    occupation: 'å•†äºº', 
                    location: 'åŠå…¬å®¤', 
                    x: 5, y: 1, 
                    energy: 80, 
                    mood: 'å¿™ç¢Œ', 
                    personality: 'ç²¾æ˜èƒ½å¹²ï¼Œå–„äºäº¤é™…',
                    background: 'å•†å­¦é™¢æ¯•ä¸šï¼Œæœ‰ä¸°å¯Œçš„å•†ä¸šç»éªŒ',
                    expertise: ['å•†ä¸šç­–ç•¥', 'æŠ•èµ„åˆ†æ', 'å¸‚åœºæ´å¯Ÿ', 'äººé™…äº¤å¾€'],
                    preferences: ['åŠå…¬å®¤', 'å’–å•¡å…', 'é¤å…'],
                    relationships: {}, 
                    lastInteraction: null,
                    memories: [],
                    currentThoughts: ''
                },
                'Lisa': {
                    emoji: 'ğŸ‘©â€ğŸ“', 
                    occupation: 'å­¦ç”Ÿ', 
                    location: 'å›¾ä¹¦é¦†', 
                    x: 4, y: 3, 
                    energy: 95, 
                    mood: 'å…´å¥‹', 
                    personality: 'å¥½å­¦ä¸Šè¿›ï¼Œå……æ»¡æ´»åŠ›',
                    background: 'å¤§å­¦ç”Ÿï¼Œæ­£åœ¨å­¦ä¹ è®¡ç®—æœºç§‘å­¦',
                    expertise: ['å­¦ä¹ ', 'æé—®', 'å¸æ”¶çŸ¥è¯†', 'æŠ€æœ¯æ¢ç´¢'],
                    preferences: ['å›¾ä¹¦é¦†', 'å’–å•¡å…', 'å…¬å›­'],
                    relationships: {}, 
                    lastInteraction: null,
                    memories: [],
                    currentThoughts: ''
                },
                'Mike': {
                    emoji: 'ğŸ‘´', 
                    occupation: 'é€€ä¼‘äººå‘˜', 
                    location: 'å…¬å›­', 
                    x: 2, y: 1, 
                    energy: 60, 
                    mood: 'å¹³é™', 
                    personality: 'æ‚ é—²è‡ªåœ¨ï¼Œç»éªŒä¸°å¯Œ',
                    background: 'é€€ä¼‘å·¥ç¨‹å¸ˆï¼Œæœ‰ä¸°å¯Œçš„äººç”Ÿç»éªŒ',
                    expertise: ['äººç”Ÿç»éªŒ', 'æ•…äº‹åˆ†äº«', 'ç”Ÿæ´»æ™ºæ…§', 'ä¼‘é—²å¨±ä¹'],
                    preferences: ['å…¬å›­', 'å®¶', 'å’–å•¡å…'],
                    relationships: {}, 
                    lastInteraction: null,
                    memories: [],
                    currentThoughts: ''
                },
                'John': {
                    emoji: 'ğŸ‘¨â€âš•ï¸', 
                    occupation: 'åŒ»ç”Ÿ', 
                    location: 'åŒ»é™¢', 
                    x: 0, y: 2, 
                    energy: 70, 
                    mood: 'ä¸“ä¸š', 
                    personality: 'ç»†å¿ƒè´Ÿè´£ï¼Œå…³çˆ±ç—…äºº',
                    background: 'åŒ»å­¦é™¢æ¯•ä¸šï¼Œæœ‰å¤šå¹´ä¸´åºŠç»éªŒ',
                    expertise: ['åŒ»ç–—è¯Šæ–­', 'å¥åº·å’¨è¯¢', 'ç—…äººå…³æ€€', 'åŒ»å­¦çŸ¥è¯†'],
                    preferences: ['åŒ»é™¢', 'å›¾ä¹¦é¦†', 'å’–å•¡å…'],
                    relationships: {}, 
                    lastInteraction: null,
                    memories: [],
                    currentThoughts: ''
                },
                'Anna': {
                    emoji: 'ğŸ‘©â€ğŸ³', 
                    occupation: 'å¨å¸ˆ', 
                    location: 'é¤å…', 
                    x: 5, y: 4, 
                    energy: 85, 
                    mood: 'æ„‰å¿«', 
                    personality: 'çƒ­æƒ…å¥½å®¢ï¼Œæ‰‹è‰ºç²¾æ¹›',
                    background: 'çƒ¹é¥ªå­¦æ ¡æ¯•ä¸šï¼Œæœ‰å¤šå¹´çƒ¹é¥ªç»éªŒ',
                    expertise: ['çƒ¹é¥ªæŠ€å·§', 'ç¾é£Ÿåˆ¶ä½œ', 'é£Ÿææ­é…', 'é¤é¥®æœåŠ¡'],
                    preferences: ['é¤å…', 'å®¶', 'å’–å•¡å…'],
                    relationships: {}, 
                    lastInteraction: null,
                    memories: [],
                    currentThoughts: ''
                },
                'Tom': {
                    emoji: 'ğŸ‘¨â€ğŸ”§', 
                    occupation: 'æœºæ¢°å¸ˆ', 
                    location: 'ä¿®ç†åº—', 
                    x: 1, y: 0, 
                    energy: 75, 
                    mood: 'ä¸“æ³¨', 
                    personality: 'åŠ¨æ‰‹èƒ½åŠ›å¼ºï¼Œå®ç”¨ä¸»ä¹‰',
                    background: 'æŠ€å·¥å­¦æ ¡æ¯•ä¸šï¼Œæœ‰å¤šå¹´ç»´ä¿®ç»éªŒ',
                    expertise: ['æœºæ¢°ç»´ä¿®', 'å·¥å…·ä½¿ç”¨', 'é—®é¢˜è¯Šæ–­', 'å®ç”¨æŠ€èƒ½'],
                    preferences: ['ä¿®ç†åº—', 'å®¶', 'å’–å•¡å…'],
                    relationships: {}, 
                    lastInteraction: null,
                    memories: [],
                    currentThoughts: ''
                }
            },
            chatHistory: [],
            selectedAgent: null,
            agentInteractions: [], // è®°å½•agenté—´çš„äº¤äº’
            socialNetwork: {}, // ç¤¾äº¤ç½‘ç»œ
            locationPopularity: {}, // åœ°ç‚¹çƒ­åº¦
            autoInteraction: true, // è‡ªåŠ¨äº¤äº’å¼€å…³
            systemTime: new Date(), // ç³»ç»Ÿæ—¶é—´
            lastDecayTime: new Date(), // ä¸Šæ¬¡å…³ç³»è¡°å‡æ—¶é—´
            decayInterval: 30 * 60 * 1000 // 30åˆ†é’Ÿè¡°å‡é—´éš”
        };

        let animationId;

        // åˆå§‹åŒ–ç¤¾äº¤ç½‘ç»œå’Œå…³ç³»
        function initializeSocialNetwork() {
            const agentNames = Object.keys(gameData.agents);
            
            // åˆå§‹åŒ–æ¯ä¸ªagentçš„å…³ç³»ç½‘ç»œ
            agentNames.forEach(agentA => {
                gameData.agents[agentA].relationships = {};
                agentNames.forEach(agentB => {
                    if (agentA !== agentB) {
                        // åŸºäºèŒä¸šå’Œæ€§æ ¼ç”Ÿæˆåˆå§‹å…³ç³»å¼ºåº¦
                        const strength = generateInitialRelationship(agentA, agentB);
                        gameData.agents[agentA].relationships[agentB] = {
                            strength: strength,
                            interactions: 0,
                            lastMet: null,
                            topics: [],
                            interactionHistory: [],
                            relationshipLevel: getRelationshipLevel(strength)
                        };
                    }
                });
            });
            
            // åˆå§‹åŒ–åœ°ç‚¹çƒ­åº¦
            gameData.buildings.forEach(building => {
                gameData.locationPopularity[building.name] = {
                    visits: 0,
                    currentOccupants: 0,
                    popularityScore: 50,
                    interactions: 0,
                    lastActivity: new Date()
                };
            });
        }

        // ç”Ÿæˆåˆå§‹å…³ç³»å¼ºåº¦
        function generateInitialRelationship(agentA, agentB) {
            const agentAData = gameData.agents[agentA];
            const agentBData = gameData.agents[agentB];
            
            // åŸºäºèŒä¸šç›¸æ€§
            const occupationCompatibility = {
                'ç¨‹åºå‘˜': {'è‰ºæœ¯å®¶': 0.6, 'æ•™å¸ˆ': 0.7, 'å•†äºº': 0.8, 'å­¦ç”Ÿ': 0.9, 'é€€ä¼‘äººå‘˜': 0.5, 'åŒ»ç”Ÿ': 0.7, 'å¨å¸ˆ': 0.6, 'æœºæ¢°å¸ˆ': 0.8},
                'è‰ºæœ¯å®¶': {'æ•™å¸ˆ': 0.8, 'å•†äºº': 0.5, 'å­¦ç”Ÿ': 0.9, 'é€€ä¼‘äººå‘˜': 0.7, 'åŒ»ç”Ÿ': 0.6, 'å¨å¸ˆ': 0.8, 'æœºæ¢°å¸ˆ': 0.4},
                'æ•™å¸ˆ': {'å•†äºº': 0.6, 'å­¦ç”Ÿ': 0.9, 'é€€ä¼‘äººå‘˜': 0.8, 'åŒ»ç”Ÿ': 0.8, 'å¨å¸ˆ': 0.7, 'æœºæ¢°å¸ˆ': 0.6},
                'å•†äºº': {'å­¦ç”Ÿ': 0.7, 'é€€ä¼‘äººå‘˜': 0.6, 'åŒ»ç”Ÿ': 0.7, 'å¨å¸ˆ': 0.8, 'æœºæ¢°å¸ˆ': 0.7},
                'å­¦ç”Ÿ': {'é€€ä¼‘äººå‘˜': 0.8, 'åŒ»ç”Ÿ': 0.7, 'å¨å¸ˆ': 0.6, 'æœºæ¢°å¸ˆ': 0.5},
                'é€€ä¼‘äººå‘˜': {'åŒ»ç”Ÿ': 0.8, 'å¨å¸ˆ': 0.9, 'æœºæ¢°å¸ˆ': 0.7},
                'åŒ»ç”Ÿ': {'å¨å¸ˆ': 0.7, 'æœºæ¢°å¸ˆ': 0.6},
                'å¨å¸ˆ': {'æœºæ¢°å¸ˆ': 0.8}
            };
            
            let compatibility = 0.5; // é»˜è®¤ç›¸æ€§
            
            // æŸ¥æ‰¾èŒä¸šç›¸æ€§
            if (occupationCompatibility[agentAData.occupation] && 
                occupationCompatibility[agentAData.occupation][agentBData.occupation]) {
                compatibility = occupationCompatibility[agentAData.occupation][agentBData.occupation];
            } else if (occupationCompatibility[agentBData.occupation] && 
                       occupationCompatibility[agentBData.occupation][agentAData.occupation]) {
                compatibility = occupationCompatibility[agentBData.occupation][agentAData.occupation];
            }
            
            // ä½ç½®æ•ˆæœ
            let locationEffect = 1.0;
            if (agentAData.location === agentBData.location) {
                locationEffect = 1.2; // åŒåœ°ç‚¹å¢åŠ 20%å…³ç³»
            }
            
            // æ€§æ ¼åŒ¹é…åº¦
            let personalityMatch = 1.0;
            const personalityKeywords = {
                'é€»è¾‘æ€ç»´': ['æŠ€æœ¯', 'ç¼–ç¨‹', 'ç®—æ³•', 'é—®é¢˜è§£å†³'],
                'åˆ›é€ åŠ›': ['è‰ºæœ¯', 'è®¾è®¡', 'åˆ›æ„', 'ç¾å­¦'],
                'è€å¿ƒ': ['æ•™è‚²', 'æ•™å­¦', 'æŒ‡å¯¼', 'æ²Ÿé€š'],
                'ç²¾æ˜': ['å•†ä¸š', 'æŠ•èµ„', 'å¸‚åœº', 'ç­–ç•¥'],
                'å¥½å­¦': ['å­¦ä¹ ', 'æ¢ç´¢', 'æé—®', 'å¸æ”¶'],
                'ç»éªŒ': ['äººç”Ÿ', 'æ•…äº‹', 'æ™ºæ…§', 'ä¼‘é—²'],
                'ç»†å¿ƒ': ['åŒ»ç–—', 'è¯Šæ–­', 'å…³æ€€', 'ä¸“ä¸š'],
                'çƒ­æƒ…': ['çƒ¹é¥ª', 'ç¾é£Ÿ', 'æœåŠ¡', 'æ‰‹è‰º'],
                'å®ç”¨': ['ç»´ä¿®', 'å·¥å…·', 'æŠ€èƒ½', 'åŠ¨æ‰‹']
            };
            
            // è®¡ç®—æ€§æ ¼åŒ¹é…åº¦
            const agentAKeywords = agentAData.expertise.join(' ');
            const agentBKeywords = agentBData.expertise.join(' ');
            
            let commonKeywords = 0;
            Object.values(personalityKeywords).forEach(keywords => {
                keywords.forEach(keyword => {
                    if (agentAKeywords.includes(keyword) && agentBKeywords.includes(keyword)) {
                        commonKeywords++;
                    }
                });
            });
            
            if (commonKeywords > 0) {
                personalityMatch = 1.0 + (commonKeywords * 0.1);
            }
            
            // æ·»åŠ éšæœºå› ç´ 
            const randomFactor = 0.8 + Math.random() * 0.4; // 0.8-1.2
            
            // è®¡ç®—æœ€ç»ˆå…³ç³»å¼ºåº¦
            const finalStrength = compatibility * locationEffect * personalityMatch * randomFactor;
            
            return Math.min(1.0, Math.max(0.1, finalStrength));
        }

        // è·å–å…³ç³»ç­‰çº§
        function getRelationshipLevel(strength) {
            if (strength >= 0.8) return 'äº²å¯†æœ‹å‹';
            if (strength >= 0.6) return 'å¥½æœ‹å‹';
            if (strength >= 0.4) return 'æ™®é€šæœ‹å‹';
            if (strength >= 0.2) return 'ç†Ÿäºº';
            return 'é™Œç”Ÿäºº';
        }

        // å…³ç³»è¡°å‡ç³»ç»Ÿ
        function applyRelationshipDecay() {
            const now = new Date();
            const timeDiff = now - gameData.lastDecayTime;
            
            if (timeDiff >= gameData.decayInterval) {
                const agentNames = Object.keys(gameData.agents);
                
                agentNames.forEach(agentA => {
                    agentNames.forEach(agentB => {
                        if (agentA !== agentB) {
                            const relationship = gameData.agents[agentA].relationships[agentB];
                            if (relationship) {
                                // åŸºç¡€è¡°å‡
                                const baseDecay = 0.02;
                                
                                // æ ¹æ®å…³ç³»å¼ºåº¦è°ƒæ•´è¡°å‡
                                let decayRate = baseDecay;
                                if (relationship.strength > 0.7) {
                                    decayRate *= 0.5; // äº²å¯†æœ‹å‹è¡°å‡è¾ƒæ…¢
                                } else if (relationship.strength < 0.3) {
                                    decayRate *= 1.5; // é™Œç”Ÿäººè¡°å‡è¾ƒå¿«
                                }
                                
                                // éšæœºè¡°å‡
                                if (Math.random() < 0.15) { // 15%æ¦‚ç‡é¢å¤–è¡°å‡
                                    const randomDecay = Math.random() * 0.01;
                                    decayRate += randomDecay;
                                }
                                
                                // åº”ç”¨è¡°å‡
                                relationship.strength = Math.max(0.1, relationship.strength - decayRate);
                                relationship.relationshipLevel = getRelationshipLevel(relationship.strength);
                            }
                        }
                    });
                });
                
                gameData.lastDecayTime = now;
                console.log('å…³ç³»è¡°å‡å·²åº”ç”¨');
            }
        }

        // åˆå§‹åŒ–ç²’å­æ•ˆæœ
        function initParticles() {
            const particlesContainer = document.getElementById('particles');
            const particleCount = 50;
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.left = Math.random() * 100 + '%';
                particle.style.animationDelay = Math.random() * 20 + 's';
                particle.style.animationDuration = (15 + Math.random() * 10) + 's';
                particlesContainer.appendChild(particle);
            }
        }

        // ä¸»é¢˜åˆ‡æ¢
        function toggleTheme() {
            const body = document.body;
            const themeIcon = document.getElementById('themeIcon');
            const currentTheme = body.getAttribute('data-theme');
            
            if (currentTheme === 'dark') {
                body.setAttribute('data-theme', 'light');
                themeIcon.className = 'fas fa-sun';
                showNotification('å·²åˆ‡æ¢åˆ°æµ…è‰²ä¸»é¢˜', 'success');
            } else {
                body.setAttribute('data-theme', 'dark');
                themeIcon.className = 'fas fa-moon';
                showNotification('å·²åˆ‡æ¢åˆ°æ·±è‰²ä¸»é¢˜', 'success');
            }
        }

        // é€šçŸ¥ç³»ç»Ÿ
        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // ç”Ÿæˆ3Dåœ°å›¾
        function generateMap() {
            const mapGrid = document.getElementById('mapGrid');
            mapGrid.innerHTML = '';
            
            for (let y = 0; y < 6; y++) {
                for (let x = 0; x < 6; x++) {
                    const cell = document.createElement('div');
                    cell.className = 'map-cell';
                    cell.setAttribute('data-x', x);
                    cell.setAttribute('data-y', y);
                    
                    let cellContent = 'â¬œ';
                    let cellClass = 'map-cell';
                    let tooltip = `åæ ‡ (${x}, ${y})`;
                    
                    // æ£€æŸ¥å»ºç­‘
                    const building = gameData.buildings.find(b => b.x === x && b.y === y);
                    if (building) {
                        cellContent = building.emoji;
                        cellClass += ' building';
                        tooltip = `${building.name} - ${building.description}`;
                    }
                    
                    // æ£€æŸ¥Agentï¼ˆä¼˜å…ˆæ˜¾ç¤ºï¼‰
                    const agentsHere = Object.entries(gameData.agents).filter(([name, agent]) => agent.x === x && agent.y === y);
                    if (agentsHere.length > 0) {
                        if (agentsHere.length === 1) {
                            cellContent = agentsHere[0][1].emoji;
                            tooltip = `${agentsHere[0][0]} (${agentsHere[0][1].occupation}) - ${agentsHere[0][1].mood}`;
                        } else {
                            cellContent = `ğŸ‘¥${agentsHere.length}`;
                            tooltip = `${agentsHere.map(([name]) => name).join(', ')}`;
                        }
                        cellClass += ' agent';
                    }
                    
                    cell.className = cellClass;
                    cell.textContent = cellContent;
                    cell.title = tooltip;
                    cell.onclick = () => showCellInfo(x, y);
                    
                    mapGrid.appendChild(cell);
                }
            }
        }

        // æ˜¾ç¤ºæ ¼å­è¯¦ç»†ä¿¡æ¯
        function showCellInfo(x, y) {
            let info = `ğŸ“ ä½ç½® (${x}, ${y})\n\n`;
            
            const building = gameData.buildings.find(b => b.x === x && b.y === y);
            if (building) {
                info += `ğŸ¢ å»ºç­‘: ${building.emoji} ${building.name}\nğŸ“ ${building.description}\n\n`;
            }
            
            const agentsHere = Object.entries(gameData.agents).filter(([name, agent]) => agent.x === x && agent.y === y);
            if (agentsHere.length > 0) {
                info += `ğŸ¤– Agent:\n`;
                agentsHere.forEach(([name, agent]) => {
                    info += `â€¢ ${agent.emoji} ${name} (${agent.occupation})\n  ğŸ’­ ${agent.mood} | âš¡ ${agent.energy}%\n  ğŸ§  ${agent.personality}\n\n`;
                });
            }
            
            if (!building && agentsHere.length === 0) {
                info += "ğŸŒ± è¿™é‡Œæ˜¯ç©ºåœ°ï¼Œç­‰å¾…å¼€å‘...";
            }
            
            showNotification(`æŸ¥çœ‹ä½ç½® (${x}, ${y}) è¯¦æƒ…`, 'success');
            alert(info);
        }

        // ç”ŸæˆAgentå¡ç‰‡
        function generateAgentCards() {
            const agentsGrid = document.getElementById('agentsGrid');
            agentsGrid.innerHTML = '';
            
            Object.entries(gameData.agents).forEach(([name, agent]) => {
                const energyColor = agent.energy > 70 ? 'var(--success)' : agent.energy > 40 ? 'var(--warning)' : 'var(--error)';
                
                // è®¡ç®—å…³ç³»ç»Ÿè®¡
                const relationships = agent.relationships || {};
                const totalRelationships = Object.keys(relationships).length;
                const strongRelationships = Object.values(relationships).filter(rel => rel.strength > 0.6).length;
                const avgRelationshipStrength = totalRelationships > 0 ? 
                    Object.values(relationships).reduce((sum, rel) => sum + rel.strength, 0) / totalRelationships : 0;
                
                const card = document.createElement('div');
                card.className = 'agent-card';
                card.onclick = () => selectAgent(name);
                
                card.innerHTML = `
                    <div class="agent-header">
                        <div class="agent-avatar">${agent.emoji}</div>
                        <div class="agent-info">
                            <h4>${name}</h4>
                            <p>${agent.occupation}</p>
                            <p style="font-size: 0.8rem; color: var(--text-secondary);">${agent.background}</p>
                        </div>
                    </div>
                    <div class="agent-stats">
                        <div class="stat-item">ğŸ“ ${agent.location}</div>
                        <div class="stat-item">ğŸ˜Š ${agent.mood}</div>
                        <div class="stat-item">
                            âš¡ ${agent.energy}%
                            <div class="energy-bar">
                                <div class="energy-fill" style="width: ${agent.energy}%; background: ${energyColor};"></div>
                            </div>
                        </div>
                        <div class="stat-item">ğŸ¯ (${agent.x}, ${agent.y})</div>
                        <div class="stat-item">â¤ï¸ ${strongRelationships}/${totalRelationships} å¥½å‹</div>
                        <div class="stat-item">ğŸ§  ${agent.memories.length} è®°å¿†</div>
                    </div>
                    <div style="margin-top: 10px; font-size: 0.8rem; color: var(--text-secondary);">
                        <strong>ä¸“é•¿:</strong> ${agent.expertise.slice(0, 3).join(', ')}${agent.expertise.length > 3 ? '...' : ''}
                    </div>
                `;
                
                agentsGrid.appendChild(card);
            });
        }

        // é€‰æ‹©Agent
        function selectAgent(agentName) {
            gameData.selectedAgent = agentName;
            const agent = gameData.agents[agentName];
            
            // æ›´æ–°UIçŠ¶æ€
            document.querySelectorAll('.agent-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
            
            // æ›´æ–°èŠå¤©æ ‡é¢˜
            document.getElementById('chatTitle').innerHTML = `
                ${agent.emoji} ${agentName} - ${agent.occupation}
            `;
            
            // å¯ç”¨èŠå¤©è¾“å…¥
            document.getElementById('messageInput').disabled = false;
            document.getElementById('sendBtn').disabled = false;
            document.getElementById('messageInput').placeholder = `ä¸ ${agentName} å¯¹è¯...`;
            
            showNotification(`å·²é€‰æ‹© ${agentName}ï¼Œå¼€å§‹å¯¹è¯å§ï¼`, 'success');
        }

        // å‘é€æ¶ˆæ¯
        function sendMessage() {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message || !gameData.selectedAgent) return;
            
            const agent = gameData.agents[gameData.selectedAgent];
            
            // æ·»åŠ ç”¨æˆ·æ¶ˆæ¯
            addMessage('user', 'ğŸ§‘ ä½ ', message);
            
            // æ¨¡æ‹ŸAIæ€è€ƒ
            const sendBtn = document.getElementById('sendBtn');
            sendBtn.innerHTML = '<div class="loading"></div>';
            sendBtn.disabled = true;
            
            setTimeout(() => {
                const response = generateAgentResponse(gameData.selectedAgent, message);
                addMessage('agent', `${agent.emoji} ${gameData.selectedAgent}`, response);
                
                // æ›´æ–°AgentçŠ¶æ€
                updateAgentAfterChat(gameData.selectedAgent);
                
                sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i>';
                sendBtn.disabled = false;
            }, 1000 + Math.random() * 2000); // 1-3ç§’æ€è€ƒæ—¶é—´
            
            messageInput.value = '';
        }

        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©
        function addMessage(type, sender, content) {
            const chatMessages = document.getElementById('chatMessages');
            
            // æ¸…ç©ºåˆå§‹æç¤º
            if (chatMessages.children.length === 1 && chatMessages.children[0].style.textAlign === 'center') {
                chatMessages.innerHTML = '';
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            const timestamp = new Date().toLocaleTimeString();
            
            messageDiv.innerHTML = `
                <div class="message-avatar">${sender.split(' ')[0]}</div>
                <div class="message-content">
                    <div style="font-size: 0.8rem; opacity: 0.7; margin-bottom: 4px;">
                        ${sender} â€¢ ${timestamp}
                    </div>
                    ${content}
                </div>
            `;
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // ä¿å­˜åˆ°å†å²è®°å½•
            gameData.chatHistory.push({
                type, sender, content, timestamp
            });
        }

        // è§¦å‘agenté—´äº¤äº’
        function triggerAgentInteraction() {
            const agentNames = Object.keys(gameData.agents);
            const interactingAgents = [];
            
            // æ‰¾åˆ°åœ¨åŒä¸€ä½ç½®çš„agents
            const locationGroups = {};
            agentNames.forEach(name => {
                const agent = gameData.agents[name];
                const key = `${agent.x},${agent.y}`;
                if (!locationGroups[key]) {
                    locationGroups[key] = [];
                }
                locationGroups[key].push(name);
            });
            
            // åœ¨æœ‰å¤šä¸ªagentçš„ä½ç½®è§¦å‘äº¤äº’
            Object.values(locationGroups).forEach(group => {
                if (group.length >= 2) {
                    // éšæœºé€‰æ‹©2ä¸ªæˆ–æ›´å¤šagentsè¿›è¡Œäº¤äº’
                    const shuffled = group.sort(() => 0.5 - Math.random());
                    const participants = shuffled.slice(0, Math.min(3, shuffled.length));
                    
                    if (participants.length >= 2) {
                        executeAgentInteraction(participants);
                    }
                }
            });
            
            // å¦‚æœæ²¡æœ‰è‡ªç„¶äº¤äº’ï¼Œéšæœºåˆ›å»ºä¸€ä¸ª
            if (interactingAgents.length === 0) {
                const randomAgents = agentNames.sort(() => 0.5 - Math.random()).slice(0, 2);
                executeAgentInteraction(randomAgents);
            }
        }

        // æ‰§è¡Œagentäº¤äº’
        function executeAgentInteraction(participants) {
            const location = gameData.agents[participants[0]].location;
            const interactionType = getInteractionType(participants, location);
            const conversation = generateGroupConversation(participants, interactionType, location);
            
            // è®°å½•äº¤äº’
            const interaction = {
                id: Date.now(),
                timestamp: new Date().toLocaleTimeString(),
                participants: participants,
                location: location,
                type: interactionType,
                conversation: conversation
            };
            
            gameData.agentInteractions.unshift(interaction);
            
            // æ›´æ–°å…³ç³»å¼ºåº¦
            let totalRelationshipChange = 0;
            participants.forEach(agentA => {
                participants.forEach(agentB => {
                    if (agentA !== agentB) {
                        const change = updateRelationship(agentA, agentB, interactionType, participants, location);
                        totalRelationshipChange += change;
                    }
                });
            });
            
            // æ›´æ–°åœ°ç‚¹çƒ­åº¦
            if (gameData.locationPopularity[location]) {
                gameData.locationPopularity[location].interactions = 
                    (gameData.locationPopularity[location].interactions || 0) + 1;
                gameData.locationPopularity[location].popularityScore += 0.1;
                gameData.locationPopularity[location].lastActivity = new Date();
            }
            
            // æ˜¾ç¤ºäº¤äº’
            displayInteraction(interaction);
            
            // æ˜¾ç¤ºå…³ç³»å˜åŒ–ä¿¡æ¯
            const changeText = totalRelationshipChange > 0 ? 
                `å…³ç³»æ€»ä½“æå‡ ${(totalRelationshipChange * 100).toFixed(1)}%` : 
                `å…³ç³»æ€»ä½“ä¸‹é™ ${Math.abs(totalRelationshipChange * 100).toFixed(1)}%`;
            
            showNotification(`${participants.join(', ')} åœ¨${location}è¿›è¡Œäº†${interactionType}ï¼Œ${changeText}`, 'success');
        }

        // è·å–äº¤äº’ç±»å‹
        function getInteractionType(participants, location) {
            const locationInteractions = {
                'å’–å•¡å…': ['é—²èŠ', 'å·¥ä½œè®¨è®º', 'æ”¾æ¾äº¤è°ˆ', 'å•†åŠ¡æ´½è°ˆ', 'åˆ›æ„äº¤æµ'],
                'å›¾ä¹¦é¦†': ['å­¦æœ¯è®¨è®º', 'çŸ¥è¯†åˆ†äº«', 'å®‰é™äº¤æµ', 'å­¦ä¹ æŒ‡å¯¼', 'ç ”ç©¶åˆä½œ'],
                'å…¬å›­': ['æ•£æ­¥èŠå¤©', 'è¿åŠ¨äº¤æµ', 'ä¼‘é—²å¯¹è¯', 'æˆ·å¤–æ´»åŠ¨', 'è‡ªç„¶æ¢ç´¢'],
                'åŠå…¬å®¤': ['å·¥ä½œåä½œ', 'ä¸šåŠ¡è®¨è®º', 'é¡¹ç›®äº¤æµ', 'æŠ€æœ¯åˆ†äº«', 'å›¢é˜Ÿå»ºè®¾'],
                'å®¶': ['ç§äººè°ˆè¯', 'å®¶åº­è¯é¢˜', 'æ·±å…¥äº¤æµ', 'æƒ…æ„Ÿåˆ†äº«', 'ç”Ÿæ´»è®¨è®º'],
                'åŒ»é™¢': ['å¥åº·å’¨è¯¢', 'å…³æ€€å¯¹è¯', 'ä¸“ä¸šäº¤æµ', 'åŒ»ç–—è®¨è®º', 'ç—…æƒ…åˆ†æ'],
                'é¤å…': ['ç”¨é¤èŠå¤©', 'ç¾é£Ÿè®¨è®º', 'ç¤¾äº¤èšé¤', 'çƒ¹é¥ªæŠ€å·§', 'é¥®é£Ÿæ–‡åŒ–'],
                'ä¿®ç†åº—': ['æŠ€æœ¯äº¤æµ', 'å®ç”¨è®¨è®º', 'ç»éªŒåˆ†äº«', 'å·¥å…·ä½¿ç”¨', 'é—®é¢˜è§£å†³']
            };
            
            const options = locationInteractions[location] || ['ä¸€èˆ¬äº¤æµ', 'å‹å¥½å¯¹è¯', 'éšæ„èŠå¤©'];
            
            // æ ¹æ®å‚ä¸è€…å…³ç³»å†³å®šäº¤äº’ç±»å‹
            const agentA = participants[0];
            const agentB = participants[1];
            const relationship = gameData.agents[agentA].relationships[agentB];
            
            if (relationship) {
                const strength = relationship.strength;
                
                // å…³ç³»å¼ºåº¦å½±å“äº¤äº’ç±»å‹æ¦‚ç‡
                if (strength > 0.7) {
                    // äº²å¯†æœ‹å‹ï¼šæ›´å¤šæ­£é¢äº¤äº’
                    const positiveTypes = ['æ·±å…¥äº¤æµ', 'æƒ…æ„Ÿåˆ†äº«', 'åˆ›æ„åˆä½œ', 'çŸ¥è¯†åˆ†äº«'];
                    if (Math.random() < 0.7) {
                        return positiveTypes[Math.floor(Math.random() * positiveTypes.length)];
                    }
                } else if (strength < 0.3) {
                    // é™Œç”Ÿäººï¼šå¯èƒ½äº§ç”Ÿè´Ÿé¢äº¤äº’
                    if (Math.random() < 0.3) {
                        const negativeTypes = ['è¯¯è§£', 'åˆ†æ­§', 'å°´å°¬å¯¹è¯'];
                        return negativeTypes[Math.floor(Math.random() * negativeTypes.length)];
                    }
                }
            }
            
            return options[Math.floor(Math.random() * options.length)];
        }

        // è®¡ç®—å…³ç³»å˜åŒ–
        function calculateRelationshipChange(interactionType, participants, location) {
            const baseChanges = {
                // æ­£é¢äº¤äº’
                'é—²èŠ': 0.05, 'å·¥ä½œè®¨è®º': 0.08, 'å­¦æœ¯è®¨è®º': 0.1, 'æ•£æ­¥èŠå¤©': 0.06,
                'æŠ€æœ¯äº¤æµ': 0.09, 'ç¾é£Ÿè®¨è®º': 0.07, 'æ·±å…¥äº¤æµ': 0.12, 'ä¸“ä¸šäº¤æµ': 0.1,
                'åˆ›æ„äº¤æµ': 0.11, 'å­¦ä¹ æŒ‡å¯¼': 0.09, 'ç ”ç©¶åˆä½œ': 0.12, 'æˆ·å¤–æ´»åŠ¨': 0.08,
                'å›¢é˜Ÿå»ºè®¾': 0.11, 'æƒ…æ„Ÿåˆ†äº«': 0.13, 'ç”Ÿæ´»è®¨è®º': 0.08, 'çƒ¹é¥ªæŠ€å·§': 0.09,
                'é¥®é£Ÿæ–‡åŒ–': 0.08, 'å·¥å…·ä½¿ç”¨': 0.07, 'é—®é¢˜è§£å†³': 0.1,
                
                // è´Ÿé¢äº¤äº’
                'è¯¯è§£': -0.15, 'åˆ†æ­§': -0.18, 'å°´å°¬å¯¹è¯': -0.12, 'äº‰è®º': -0.20,
                'å†²çª': -0.25, 'è¯¯è§£': -0.15, 'ä¸æ„‰å¿«': -0.16, 'åˆ†æ­§è®¨è®º': -0.17
            };
            
            let change = baseChanges[interactionType] || 0.05;
            
            // ä½ç½®æ•ˆæœ
            const locationEffects = {
                'å’–å•¡å…': 1.1, 'å›¾ä¹¦é¦†': 1.0, 'å…¬å›­': 1.2, 'åŠå…¬å®¤': 0.9,
                'å®¶': 1.3, 'åŒ»é™¢': 0.8, 'é¤å…': 1.1, 'ä¿®ç†åº—': 0.9
            };
            
            change *= (locationEffects[location] || 1.0);
            
            // å‚ä¸è€…æ•°é‡æ•ˆæœ
            if (participants.length > 2) {
                change *= 0.8; // ç¾¤ä½“äº¤äº’æ•ˆæœç¨å¼±
            }
            
            // å…³ç³»å¼ºåº¦æ•ˆæœ
            const agentA = participants[0];
            const agentB = participants[1];
            const relationship = gameData.agents[agentA].relationships[agentB];
            
            if (relationship) {
                if (change > 0) {
                    // æ­£é¢å˜åŒ–ï¼šå…³ç³»è¶Šå¼ºï¼Œå¢é•¿è¶Šæ…¢
                    if (relationship.strength > 0.7) {
                        change *= 0.7;
                    } else if (relationship.strength < 0.3) {
                        change *= 1.3;
                    }
                } else {
                    // è´Ÿé¢å˜åŒ–ï¼šå…³ç³»è¶Šå¼ºï¼Œä¼¤å®³è¶Šæ·±
                    if (relationship.strength > 0.7) {
                        change *= 1.2;
                    } else if (relationship.strength < 0.3) {
                        change *= 0.8;
                    }
                }
            }
            
            return change;
        }

        // æ›´æ–°å…³ç³»å¼ºåº¦
        function updateRelationship(agentA, agentB, interactionType, participants, location) {
            const relationship = gameData.agents[agentA].relationships[agentB];
            if (relationship) {
                // è®¡ç®—å…³ç³»å˜åŒ–
                const change = calculateRelationshipChange(interactionType, participants, location);
                
                // åº”ç”¨å˜åŒ–
                relationship.strength = Math.max(0.1, Math.min(1.0, relationship.strength + change));
                relationship.interactions += 1;
                relationship.lastMet = new Date().toISOString();
                
                // è®°å½•äº¤äº’å†å²
                relationship.interactionHistory.push({
                    type: interactionType,
                    change: change,
                    timestamp: new Date().toISOString(),
                    location: location,
                    participants: participants
                });
                
                // é™åˆ¶å†å²è®°å½•æ•°é‡
                if (relationship.interactionHistory.length > 20) {
                    relationship.interactionHistory = relationship.interactionHistory.slice(-20);
                }
                
                // æ›´æ–°å…³ç³»ç­‰çº§
                relationship.relationshipLevel = getRelationshipLevel(relationship.strength);
                
                // æ·»åŠ è¯é¢˜
                if (!relationship.topics.includes(interactionType)) {
                    relationship.topics.push(interactionType);
                }
                
                // æ›´æ–°åœ°ç‚¹çƒ­åº¦
                if (gameData.locationPopularity[location]) {
                    gameData.locationPopularity[location].interactions = 
                        (gameData.locationPopularity[location].interactions || 0) + 1;
                    gameData.locationPopularity[location].popularityScore += 0.1;
                    gameData.locationPopularity[location].lastActivity = new Date();
                }
                
                return change;
            }
            return 0;
        }

        // ç”Ÿæˆç¾¤ä½“å¯¹è¯
        function generateGroupConversation(participants, interactionType, location) {
            const conversation = [];
            const agentTemplates = {
                'Alex': ['ä»æŠ€æœ¯è§’åº¦æ¥è¯´...', 'æˆ‘è§‰å¾—å¯ä»¥ç”¨ç¼–ç¨‹æ€ç»´è§£å†³', 'è¿™è®©æˆ‘æƒ³åˆ°äº†ç®—æ³•é—®é¢˜'],
                'Emma': ['è¿™å¾ˆæœ‰è‰ºæœ¯æ„Ÿï¼', 'æˆ‘æƒ³ç”»ä¸‹è¿™ä¸ªåœºæ™¯', 'åˆ›æ„å°±æ˜¯è¿™æ ·äº§ç”Ÿçš„'],
                'Sarah': ['è¿™æ˜¯ä¸ªå¾ˆå¥½çš„å­¦ä¹ æœºä¼š', 'è®©æˆ‘æ¥åˆ†äº«ä¸€äº›ç»éªŒ', 'æ•™è‚²çš„æœ¬è´¨æ˜¯...'],
                'David': ['ä»å•†ä¸šè§’åº¦è€ƒè™‘', 'è¿™æœ‰å¾ˆå¤§çš„å¸‚åœºæ½œåŠ›', 'æˆ‘ä»¬å¯ä»¥åˆä½œ...'],
                'Lisa': ['å¤ªæœ‰è¶£äº†ï¼', 'æˆ‘è¦è®°å½•ä¸‹æ¥', 'èƒ½è¯¦ç»†è¯´è¯´å—ï¼Ÿ'],
                'Mike': ['å¹´è½»æ—¶æˆ‘ä¹Ÿé‡åˆ°è¿‡', 'ç»éªŒå‘Šè¯‰æˆ‘...', 'äººç”Ÿå¦‚èŒ¶...'],
                'John': ['ä»åŒ»å­¦è§’åº¦çœ‹', 'å¥åº·å¾ˆé‡è¦', 'é¢„é˜²èƒœäºæ²»ç–—'],
                'Anna': ['è¿™è®©æˆ‘æƒ³åˆ°ç¾é£Ÿ', 'çƒ¹é¥ªå’Œç”Ÿæ´»ä¸€æ ·', 'å‘³é“æ˜¯æƒ…æ„Ÿçš„è¡¨è¾¾'],
                'Tom': ['å®é™…æ“ä½œæ˜¯å…³é”®', 'åŠ¨æ‰‹èƒ½åŠ›å¾ˆé‡è¦', 'å·¥å…·å’ŒæŠ€å·§...']
            };
            
            participants.forEach((participant, index) => {
                const templates = agentTemplates[participant] || ['æˆ‘è§‰å¾—...', 'æœ‰é“ç†', 'ç¡®å®å¦‚æ­¤'];
                const response = templates[Math.floor(Math.random() * templates.length)];
                conversation.push({
                    speaker: participant,
                    message: `${response}å…³äº${interactionType}çš„è¯é¢˜ã€‚`
                });
            });
            
            return conversation;
        }

        // æ˜¾ç¤ºäº¤äº’è®°å½•
        function displayInteraction(interaction) {
            const feed = document.getElementById('interactionFeed');
            
            // æ¸…ç©ºåˆå§‹æç¤º
            if (feed.children.length === 1 && feed.children[0].style.textAlign === 'center') {
                feed.innerHTML = '';
            }
            
            const interactionDiv = document.createElement('div');
            interactionDiv.className = 'interaction-item';
            
            const participantTags = interaction.participants.map(name => 
                `<span class="participant-tag">${gameData.agents[name].emoji} ${name}</span>`
            ).join('');
            
            const conversationText = interaction.conversation.map(conv => 
                `<strong>${conv.speaker}:</strong> ${conv.message}`
            ).join('<br>');
            
            interactionDiv.innerHTML = `
                <div class="interaction-header">
                    <i class="fas fa-clock"></i>
                    <span>${interaction.timestamp}</span>
                    <span>â€¢</span>
                    <i class="fas fa-map-marker-alt"></i>
                    <span>${interaction.location}</span>
                    <span>â€¢</span>
                    <span>${interaction.type}</span>
                </div>
                <div class="interaction-participants">
                    ${participantTags}
                </div>
                <div class="interaction-content">
                    ${conversationText}
                </div>
            `;
            
            feed.insertBefore(interactionDiv, feed.firstChild);
            
            // é™åˆ¶æ˜¾ç¤ºçš„äº¤äº’æ•°é‡
            while (feed.children.length > 20) {
                feed.removeChild(feed.lastChild);
            }
        }

        // æ˜¾ç¤ºç¤¾äº¤ç½‘ç»œ
        function showSocialNetwork() {
            const modal = document.getElementById('socialNetworkModal');
            const content = document.getElementById('socialNetworkContent');
            
            let html = '<div class="relationship-grid">';
            
            Object.entries(gameData.agents).forEach(([agentName, agent]) => {
                html += `
                    <div class="relationship-card">
                        <div class="relationship-header">
                            <span style="font-size: 1.5rem;">${agent.emoji}</span>
                            <div>
                                <h4 style="margin: 0;">${agentName}</h4>
                                <p style="margin: 0; font-size: 0.8rem; color: var(--text-secondary);">${agent.occupation}</p>
                            </div>
                        </div>
                        <div style="margin-top: 10px;">
                `;
                
                // æ˜¾ç¤ºä¸å…¶ä»–agentçš„å…³ç³»
                Object.entries(agent.relationships || {}).forEach(([otherAgent, relationship]) => {
                    const strengthPercent = Math.round(relationship.strength * 100);
                    const strengthColor = relationship.strength > 0.7 ? 'var(--success)' : 
                                         relationship.strength > 0.4 ? 'var(--warning)' : 'var(--error)';
                    
                    html += `
                        <div class="relationship-strength">
                            <span style="font-size: 0.9rem;">${gameData.agents[otherAgent].emoji} ${otherAgent}</span>
                            <div class="strength-bar">
                                <div class="strength-fill" style="width: ${strengthPercent}%; background: ${strengthColor};"></div>
                            </div>
                            <span>${strengthPercent}%</span>
                        </div>
                    `;
                });
                
                html += '</div></div>';
            });
            
            html += '</div>';
            content.innerHTML = html;
            modal.classList.add('show');
        }

        // å…³é—­ç¤¾äº¤ç½‘ç»œæ¨¡æ€æ¡†
        function closeSocialNetwork() {
            document.getElementById('socialNetworkModal').classList.remove('show');
        }

        // ç»„ç»‡ç¾¤ä½“æ´»åŠ¨
        function organizeGroupActivity() {
            const activities = [
                {name: 'å›¾ä¹¦é¦†è¯»ä¹¦ä¼š', location: 'å›¾ä¹¦é¦†', participants: ['Sarah', 'Lisa', 'Alex']},
                {name: 'å…¬å›­é‡é¤èšä¼š', location: 'å…¬å›­', participants: ['Emma', 'Mike', 'Anna']},
                {name: 'å’–å•¡å…å•†åŠ¡æ´½è°ˆ', location: 'å’–å•¡å…', participants: ['David', 'Alex', 'John']},
                {name: 'é¤å…ç¾é£Ÿå“é‰´', location: 'é¤å…', participants: ['Anna', 'Emma', 'Sarah']},
                {name: 'åŠå…¬å®¤æŠ€æœ¯è®¨è®º', location: 'åŠå…¬å®¤', participants: ['Alex', 'Tom', 'David']},
                {name: 'åŒ»é™¢å¥åº·è®²åº§', location: 'åŒ»é™¢', participants: ['John', 'Sarah', 'Mike']}
            ];
            
            const activity = activities[Math.floor(Math.random() * activities.length)];
            
            // ç§»åŠ¨participantsåˆ°æŒ‡å®šä½ç½®
            const building = gameData.buildings.find(b => b.name === activity.location);
            if (building) {
                activity.participants.forEach(agentName => {
                    if (gameData.agents[agentName]) {
                        gameData.agents[agentName].x = building.x;
                        gameData.agents[agentName].y = building.y;
                        gameData.agents[agentName].location = building.name;
                    }
                });
                
                // è§¦å‘ç¾¤ä½“äº¤äº’
                executeAgentInteraction(activity.participants);
                
                generateMap();
                generateAgentCards();
                
                showNotification(`ç»„ç»‡äº†${activity.name}ï¼Œå‚ä¸è€…ï¼š${activity.participants.join(', ')}`, 'success');
            }
        }

        // æ˜¾ç¤ºåœ°ç‚¹ç»Ÿè®¡
        function showLocationStats() {
            let statsText = "ğŸ“Š åœ°ç‚¹çƒ­åº¦ç»Ÿè®¡:\n\n";
            
            Object.entries(gameData.locationPopularity).forEach(([location, stats]) => {
                const currentCount = Object.values(gameData.agents).filter(agent => agent.location === location).length;
                statsText += `${gameData.buildings.find(b => b.name === location)?.emoji || 'ğŸ“'} ${location}:\n`;
                statsText += `  å½“å‰äººæ•°: ${currentCount}\n`;
                statsText += `  äº¤äº’æ¬¡æ•°: ${stats.interactions || 0}\n`;
                statsText += `  çƒ­åº¦åˆ†æ•°: ${(stats.popularityScore || 0).toFixed(1)}\n\n`;
            });
            
            alert(statsText);
        }

        // åˆ‡æ¢è‡ªåŠ¨äº¤äº’
        function toggleAutoInteraction() {
            gameData.autoInteraction = !gameData.autoInteraction;
            const button = document.getElementById('autoInteractionText');
            button.textContent = gameData.autoInteraction ? 'å…³é—­è‡ªåŠ¨äº¤äº’' : 'å¼€å¯è‡ªåŠ¨äº¤äº’';
            
            showNotification(
                gameData.autoInteraction ? 'è‡ªåŠ¨äº¤äº’å·²å¼€å¯' : 'è‡ªåŠ¨äº¤äº’å·²å…³é—­',
                'success'
            );
        }

        // æ¸…ç©ºäº¤äº’å†å²
        function clearInteractionHistory() {
            gameData.agentInteractions = [];
            const feed = document.getElementById('interactionFeed');
            feed.innerHTML = `
                <div style="text-align: center; color: var(--text-secondary); padding: 20px;">
                    <i class="fas fa-users" style="font-size: 2rem; margin-bottom: 10px; opacity: 0.3;"></i>
                    <p>ç­‰å¾…Agenté—´çš„äº¤äº’...</p>
                </div>
            `;
            showNotification('äº¤äº’å†å²å·²æ¸…ç©º', 'success');
        }

        function generateAgentResponse(agentName, message) {
            const agent = gameData.agents[agentName];
            
            // åŸºäºAgentæ€§æ ¼å’Œä¸“é•¿ç”Ÿæˆæ™ºèƒ½å›å¤
            const responseTemplates = {
                'Alex': {
                    keywords: ['ç¼–ç¨‹', 'ç®—æ³•', 'æŠ€æœ¯', 'é€»è¾‘', 'ä»£ç ', 'é¡¹ç›®'],
                    responses: [
                        "ä»ç¨‹åºå‘˜çš„è§’åº¦æ¥çœ‹ï¼Œè¿™ä¸ªé—®é¢˜å¾ˆæœ‰æ„æ€ï¼æˆ‘è§‰å¾—å¯ä»¥ç”¨ç®—æ³•çš„æ€ç»´æ¥è§£å†³ã€‚",
                        "è®©æˆ‘æƒ³æƒ³...è¿™å°±åƒè°ƒè¯•ä»£ç ä¸€æ ·ï¼Œéœ€è¦é€æ­¥åˆ†æé—®é¢˜çš„æ ¹æºã€‚",
                        "ç¼–ç¨‹æ•™ä¼šäº†æˆ‘é€»è¾‘æ€ç»´ï¼Œæˆ‘è®¤ä¸ºä»»ä½•é—®é¢˜éƒ½æœ‰æœ€ä¼˜è§£ã€‚",
                        "è¿™è®©æˆ‘æƒ³åˆ°äº†ä¸€ä¸ªæˆ‘æœ€è¿‘åœ¨åšçš„é¡¹ç›®ï¼ŒæŠ€æœ¯çœŸçš„å¾ˆç¥å¥‡ï¼",
                        "ä»æŠ€æœ¯è§’åº¦åˆ†æï¼Œè¿™ä¸ªé—®é¢˜å¯ä»¥è¿™æ ·è§£å†³...",
                        "ä»£ç ä¸–ç•Œé‡Œçš„é€»è¾‘æ€ç»´ï¼Œè®©æˆ‘å¯¹è¿™ä¸ªé—®é¢˜æœ‰äº†æ–°çš„ç†è§£ã€‚"
                    ]
                },
                'Emma': {
                    keywords: ['è‰ºæœ¯', 'åˆ›ä½œ', 'è‰²å½©', 'ç¾å­¦', 'çµæ„Ÿ', 'è®¾è®¡'],
                    responses: [
                        "è¿™æ¿€å‘äº†æˆ‘çš„åˆ›ä½œçµæ„Ÿï¼æˆ‘æƒ³ç”¨ç”»ç¬”è®°å½•ä¸‹è¿™ç§æ„Ÿè§‰ã€‚",
                        "è‰ºæœ¯æ¥æºäºç”Ÿæ´»ï¼Œä½ çš„è¯è®©æˆ‘çœ‹åˆ°äº†æ–°çš„è‰²å½©å’Œå¯èƒ½æ€§ã€‚",
                        "æ¯ä¸ªäººéƒ½æœ‰è‡ªå·±çš„ç¾å­¦è§‚ç‚¹ï¼Œè¿™å°±æ˜¯è‰ºæœ¯çš„é­…åŠ›æ‰€åœ¨ã€‚",
                        "æˆ‘æ­£åœ¨åˆ›ä½œä¸€ä¸ªæ–°ä½œå“ï¼Œä¹Ÿè®¸å¯ä»¥åŠ å…¥è¿™äº›å…ƒç´ ã€‚",
                        "ä»è‰ºæœ¯çš„è§’åº¦çœ‹ï¼Œè¿™ä¸ªé—®é¢˜å……æ»¡äº†ç¾æ„Ÿã€‚",
                        "è‰²å½©å’Œå½¢çŠ¶çš„ç»„åˆï¼Œè®©æˆ‘æƒ³åˆ°äº†ä¸€ä¸ªåˆ›æ„æ–¹æ¡ˆã€‚"
                    ]
                },
                'Sarah': {
                    keywords: ['æ•™è‚²', 'å­¦ä¹ ', 'çŸ¥è¯†', 'æ•™å­¦', 'æŒ‡å¯¼', 'ç»éªŒ'],
                    responses: [
                        "ä½œä¸ºè€å¸ˆï¼Œæˆ‘å¾ˆå–œæ¬¢è¿™æ ·çš„äº¤æµï¼è¿™æ˜¯å¾ˆå¥½çš„å­¦ä¹ æœºä¼šã€‚",
                        "æ•™è‚²çš„æœ¬è´¨æ˜¯å¯å‘æ€è€ƒï¼Œä½ çš„è§‚ç‚¹å¾ˆæœ‰å¯å‘æ€§ã€‚",
                        "æˆ‘ç»å¸¸å’Œå­¦ç”Ÿä»¬è®¨è®ºç±»ä¼¼çš„è¯é¢˜ï¼ŒçŸ¥è¯†çš„åˆ†äº«è®©äººå¿«ä¹ã€‚",
                        "è®©æˆ‘ä»¬ä¸€èµ·æ¢è®¨è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘å¯ä»¥åˆ†äº«ä¸€äº›æˆ‘çš„æ•™å­¦ç»éªŒã€‚",
                        "ä»æ•™è‚²è§’åº¦çœ‹ï¼Œè¿™ä¸ªé—®é¢˜å¾ˆæœ‰ä»·å€¼ã€‚",
                        "æ•™å­¦ç›¸é•¿ï¼Œä½ çš„æƒ³æ³•ä¹Ÿè®©æˆ‘å­¦åˆ°äº†æ–°ä¸œè¥¿ã€‚"
                    ]
                },
                'David': {
                    keywords: ['å•†ä¸š', 'æŠ•èµ„', 'å¸‚åœº', 'ç­–ç•¥', 'æœºä¼š', 'åˆä½œ'],
                    responses: [
                        "ä»å•†ä¸šè§’åº¦æ¥çœ‹ï¼Œè¿™é‡Œé¢æœ‰å¾ˆå¤§çš„ä»·å€¼å’Œæœºä¼šï¼",
                        "æˆåŠŸéœ€è¦ç­–ç•¥å’Œæ‰§è¡ŒåŠ›ï¼Œæˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹å¯è¡Œæ€§ã€‚",
                        "å•†åœºå¦‚æˆ˜åœºï¼Œä½†åˆä½œå…±èµ¢æ‰æ˜¯é•¿ä¹…ä¹‹é“ã€‚",
                        "æˆ‘æœ€è¿‘åœ¨è°ˆä¸€ä¸ªé¡¹ç›®ï¼Œä½ çš„æƒ³æ³•ç»™äº†æˆ‘æ–°çš„æ€è·¯ã€‚",
                        "å¸‚åœºåˆ†æå‘Šè¯‰æˆ‘ï¼Œè¿™ä¸ªæ–¹å‘å¾ˆæœ‰æ½œåŠ›ã€‚",
                        "å•†ä¸šæ€ç»´å°±æ˜¯è¦çœ‹åˆ°åˆ«äººçœ‹ä¸åˆ°çš„æœºä¼šã€‚"
                    ]
                },
                'Lisa': {
                    keywords: ['å­¦ä¹ ', 'æ¢ç´¢', 'æé—®', 'å¸æ”¶', 'è€ƒè¯•', 'åŒå­¦'],
                    responses: [
                        "å“‡ï¼Œå¤ªæœ‰è¶£äº†ï¼æˆ‘è¦æŠŠè¿™ä¸ªè®°å½•ä¸‹æ¥ï¼Œè¯´ä¸å®šè€ƒè¯•ä¼šç”¨åˆ°ã€‚",
                        "å­¦ä¹ çœŸçš„å¾ˆå¿«ä¹ï¼Œæ¯å¤©éƒ½èƒ½å­¦åˆ°æ–°ä¸œè¥¿ï¼",
                        "ä½ èƒ½è¯¦ç»†è§£é‡Šä¸€ä¸‹å—ï¼Ÿæˆ‘æƒ³æ›´æ·±å…¥åœ°ç†è§£è¿™ä¸ªæ¦‚å¿µã€‚",
                        "æˆ‘å‡†å¤‡æŠŠè¿™ä¸ªåˆ†äº«ç»™åŒå­¦ä»¬ï¼Œå¤§å®¶ä¸€èµ·è®¨è®ºä¼šæ›´æœ‰æ„æ€ã€‚",
                        "è¿™ä¸ªé—®é¢˜è®©æˆ‘æƒ³åˆ°äº†è¯¾æœ¬ä¸Šçš„å†…å®¹ã€‚",
                        "å­¦ä¹ æ–°çŸ¥è¯†çš„æ„Ÿè§‰çœŸçš„å¾ˆæ£’ï¼"
                    ]
                },
                'Mike': {
                    keywords: ['ç»éªŒ', 'äººç”Ÿ', 'æ•…äº‹', 'æ™ºæ…§', 'å¹´è½»', 'é€€ä¼‘'],
                    responses: [
                        "å¹´è½»æ—¶æˆ‘ä¹Ÿé‡åˆ°è¿‡ç±»ä¼¼çš„æƒ…å†µï¼Œç»éªŒå‘Šè¯‰æˆ‘...",
                        "äººç”Ÿå¦‚èŒ¶ï¼Œéœ€è¦æ…¢æ…¢å“å‘³ã€‚æˆ‘æœ‰å¾ˆå¤šæ•…äº‹å¯ä»¥åˆ†äº«ã€‚",
                        "ç°åœ¨çš„å¹´è½»äººçœŸæœ‰æƒ³æ³•ï¼Œæˆ‘ä»¬é‚£ä¸ªæ—¶ä»£å¯æ²¡æœ‰è¿™äº›ã€‚",
                        "é€€ä¼‘åæˆ‘æœ‰äº†æ›´å¤šæ—¶é—´æ€è€ƒï¼Œç”Ÿæ´»çš„æ™ºæ…§éœ€è¦æ²‰æ·€ã€‚",
                        "äººç”Ÿç»éªŒå‘Šè¯‰æˆ‘ï¼Œè¿™ä¸ªé—®é¢˜éœ€è¦è¿™æ ·å¤„ç†...",
                        "å¹´è½»æ—¶çš„ç»å†ï¼Œè®©æˆ‘å¯¹è¿™ä¸ªé—®é¢˜æœ‰äº†æ·±åˆ»çš„ç†è§£ã€‚"
                    ]
                },
                'John': {
                    keywords: ['åŒ»ç–—', 'å¥åº·', 'è¯Šæ–­', 'å…³æ€€', 'ç—…äºº', 'é¢„é˜²'],
                    responses: [
                        "ä»åŒ»å­¦è§’åº¦æ¥çœ‹ï¼Œè¿™ä¸ªé—®é¢˜å¾ˆé‡è¦ã€‚å¥åº·æ°¸è¿œæ˜¯ç¬¬ä¸€ä½çš„ã€‚",
                        "é¢„é˜²èƒœäºæ²»ç–—ï¼Œæˆ‘ä»¬è¦ä»æ ¹æºä¸Šè§£å†³é—®é¢˜ã€‚",
                        "ä½œä¸ºåŒ»ç”Ÿï¼Œæˆ‘è§è¿‡å¤ªå¤šæ¡ˆä¾‹ï¼Œæ¯ä¸ªäººçš„æƒ…å†µéƒ½ä¸åŒã€‚",
                        "åŒ»è€…ä»å¿ƒï¼Œæˆ‘å¸Œæœ›èƒ½å¸®åŠ©åˆ°æ›´å¤šçš„äººã€‚",
                        "ä»å¥åº·è§’åº¦è€ƒè™‘ï¼Œè¿™ä¸ªé—®é¢˜éœ€è¦é‡è§†ã€‚",
                        "åŒ»ç–—ç»éªŒå‘Šè¯‰æˆ‘ï¼Œé¢„é˜²æ¯”æ²»ç–—æ›´é‡è¦ã€‚"
                    ]
                },
                'Anna': {
                    keywords: ['çƒ¹é¥ª', 'ç¾é£Ÿ', 'é£Ÿæ', 'å‘³é“', 'å¨æˆ¿', 'æ‰‹è‰º'],
                    responses: [
                        "è¿™è®©æˆ‘æƒ³åˆ°äº†ç¾é£Ÿï¼å¥½çš„é£Ÿæé…ä¸Šå¥½å¿ƒæƒ…ï¼Œå°±æ˜¯å®Œç¾çš„èœè‚´ã€‚",
                        "çƒ¹é¥ªå°±åƒç”Ÿæ´»ï¼Œéœ€è¦ç”¨å¿ƒè°ƒå‘³ï¼Œæ¯ä¸€é“èœéƒ½æœ‰æ•…äº‹ã€‚",
                        "ä½ æƒ³å°å°æˆ‘çš„æ‹¿æ‰‹èœå—ï¼Ÿæˆ‘ä¿è¯ä¼šè®©ä½ å›å‘³æ— ç©·ï¼",
                        "å¨æˆ¿æ˜¯æˆ‘çš„è‰ºæœ¯å·¥ä½œå®¤ï¼Œæ¯ä¸€æ¬¡åˆ›ä½œéƒ½æ˜¯å¯¹å‘³è•¾çš„æŒ‘æˆ˜ã€‚",
                        "ä»ç¾é£Ÿè§’åº¦çœ‹ï¼Œè¿™ä¸ªé—®é¢˜å¾ˆæœ‰å‘³é“ã€‚",
                        "çƒ¹é¥ªæŠ€å·§å‘Šè¯‰æˆ‘ï¼Œç»†èŠ‚å†³å®šæˆè´¥ã€‚"
                    ]
                },
                'Tom': {
                    keywords: ['ç»´ä¿®', 'å·¥å…·', 'æŠ€èƒ½', 'åŠ¨æ‰‹', 'å®è·µ', 'é—®é¢˜'],
                    responses: [
                        "è¿™éœ€è¦å®é™…åŠ¨æ‰‹æ¥è§£å†³ï¼Œç†è®ºçŸ¥è¯†è¦ç»“åˆå®è·µã€‚",
                        "æˆ‘ä¿®è¿‡å„ç§å„æ ·çš„ä¸œè¥¿ï¼Œå®è·µå‡ºçœŸçŸ¥æ˜¯æˆ‘çš„åº§å³é“­ã€‚",
                        "å·¥å…·å’ŒæŠ€å·§å¾ˆé‡è¦ï¼Œä½†æ›´é‡è¦çš„æ˜¯å¯¹é—®é¢˜çš„ç†è§£ã€‚",
                        "è®©æˆ‘çœ‹çœ‹æœ‰ä»€ä¹ˆå¯ä»¥æ”¹è¿›çš„åœ°æ–¹ï¼Œæˆ‘å–œæ¬¢è§£å†³å®é™…é—®é¢˜ã€‚",
                        "ä»å®ç”¨è§’åº¦çœ‹ï¼Œè¿™ä¸ªé—®é¢˜éœ€è¦åŠ¨æ‰‹è§£å†³ã€‚",
                        "ç»´ä¿®ç»éªŒå‘Šè¯‰æˆ‘ï¼Œé—®é¢˜å¾€å¾€åœ¨ç»†èŠ‚ä¸­ã€‚"
                    ]
                }
            };
            
            const template = responseTemplates[agentName];
            if (template) {
                // æ£€æŸ¥æ¶ˆæ¯ä¸­æ˜¯å¦åŒ…å«Agentä¸“é•¿çš„å…³é”®è¯
                const hasExpertise = template.keywords.some(keyword => 
                    message.includes(keyword) || agent.expertise.some(exp => exp.includes(keyword))
                );
                
                if (hasExpertise) {
                    // å¦‚æœæ¶‰åŠä¸“é•¿ï¼Œç”Ÿæˆæ›´ä¸“ä¸šçš„å›å¤
                    const professionalResponses = [
                        `ä½œä¸º${agent.occupation}ï¼Œæˆ‘å¯¹è¿™ä¸ªé—®é¢˜å¾ˆæœ‰ç ”ç©¶ã€‚${template.responses[Math.floor(Math.random() * template.responses.length)]}`,
                        `ä»æˆ‘çš„ä¸“ä¸šè§’åº¦æ¥çœ‹ï¼Œ${template.responses[Math.floor(Math.random() * template.responses.length)]}`,
                        `è¿™æ­£å¥½æ˜¯æˆ‘çš„ä¸“é•¿é¢†åŸŸï¼${template.responses[Math.floor(Math.random() * template.responses.length)]}`
                    ];
                    return professionalResponses[Math.floor(Math.random() * professionalResponses.length)];
                } else {
                    // ä¸€èˆ¬å›å¤
                    return template.responses[Math.floor(Math.random() * template.responses.length)];
                }
            }
            
            // é»˜è®¤å›å¤
            const defaultResponses = [
                "æˆ‘ç†è§£ä½ çš„æ„æ€ï¼Œè¿™ç¡®å®å€¼å¾—æ€è€ƒã€‚",
                "æ¯ä¸ªäººéƒ½æœ‰ä¸åŒçš„è§‚ç‚¹ï¼Œè¿™å¾ˆæ­£å¸¸ã€‚",
                "è°¢è°¢ä½ çš„åˆ†äº«ï¼Œæˆ‘å­¦åˆ°äº†æ–°ä¸œè¥¿ã€‚",
                "è¿™ä¸ªé—®é¢˜å¾ˆæœ‰è¶£ï¼Œè®©æˆ‘æƒ³æƒ³...",
                "ä»æˆ‘çš„è§’åº¦æ¥è¯´ï¼Œè¿™ä¸ªæƒ³æ³•å¾ˆæœ‰é“ç†ã€‚"
            ];
            
            return defaultResponses[Math.floor(Math.random() * defaultResponses.length)];
        }

        // èŠå¤©åæ›´æ–°AgentçŠ¶æ€
        function updateAgentAfterChat(agentName) {
            const agent = gameData.agents[agentName];
            
            // éšæœºè°ƒæ•´èƒ½é‡å’Œå¿ƒæƒ…
            agent.energy = Math.max(10, Math.min(100, agent.energy + Math.floor(Math.random() * 11) - 5));
            
            const moods = ['å¼€å¿ƒ', 'ä¸“æ³¨', 'æ”¾æ¾', 'æ€è€ƒä¸­', 'å…´å¥‹', 'å¹³é™'];
            if (Math.random() < 0.3) { // 30%æ¦‚ç‡æ”¹å˜å¿ƒæƒ…
                agent.mood = moods[Math.floor(Math.random() * moods.length)];
            }
            
            // åˆ·æ–°æ˜¾ç¤º
            generateAgentCards();
            generateMap();
        }

        // å¿«é€Ÿæ¶ˆæ¯
        function quickMessage(message) {
            document.getElementById('messageInput').value = message;
        }

        // æ¸…ç©ºèŠå¤©
        function clearChat() {
            const chatMessages = document.getElementById('chatMessages');
            chatMessages.innerHTML = `
                <div style="text-align: center; color: var(--text-secondary); margin: auto;">
                    <i class="fas fa-comments" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.3;"></i>
                    <p>èŠå¤©è®°å½•å·²æ¸…ç©º</p>
                </div>
            `;
            gameData.chatHistory = [];
            showNotification('èŠå¤©è®°å½•å·²æ¸…ç©º', 'success');
        }

        // éšæœºç§»åŠ¨Agent
        function randomizeAgents() {
            Object.entries(gameData.agents).forEach(([name, agent]) => {
                const building = gameData.buildings[Math.floor(Math.random() * gameData.buildings.length)];
                agent.x = building.x;
                agent.y = building.y;
                agent.location = building.name;
                
                // æ›´æ–°å¿ƒæƒ…
                const moodEffects = {
                    'å’–å•¡å…': 'æ”¾æ¾', 'å›¾ä¹¦é¦†': 'ä¸“æ³¨', 'å…¬å›­': 'å¼€å¿ƒ',
                    'åŠå…¬å®¤': 'å¿™ç¢Œ', 'å®¶': 'èˆ’é€‚', 'åŒ»é™¢': 'ä¸¥è‚ƒ',
                    'é¤å…': 'æ„‰å¿«', 'ä¿®ç†åº—': 'ä¸“æ³¨'
                };
                agent.mood = moodEffects[building.name] || 'å¹³é™';
            });
            
            generateMap();
            generateAgentCards();
            showNotification('æ‰€æœ‰Agentå·²éšæœºç§»åŠ¨', 'success');
        }

        // é‡ç½®Agentä½ç½®
        function resetAgents() {
            const initialPositions = {
                'Alex': {location: 'åŠå…¬å®¤', x: 5, y: 1},
                'Emma': {location: 'å…¬å›­', x: 2, y: 1},
                'Sarah': {location: 'å›¾ä¹¦é¦†', x: 4, y: 3},
                'David': {location: 'åŠå…¬å®¤', x: 5, y: 1},
                'Lisa': {location: 'å›¾ä¹¦é¦†', x: 4, y: 3},
                'Mike': {location: 'å…¬å›­', x: 2, y: 1},
                'John': {location: 'åŒ»é™¢', x: 0, y: 2},
                'Anna': {location: 'é¤å…', x: 5, y: 4},
                'Tom': {location: 'ä¿®ç†åº—', x: 1, y: 0}
            };
            
            Object.entries(initialPositions).forEach(([name, pos]) => {
                if (gameData.agents[name]) {
                    gameData.agents[name].x = pos.x;
                    gameData.agents[name].y = pos.y;
                    gameData.agents[name].location = pos.location;
                }
            });
            
            generateMap();
            generateAgentCards();
            showNotification('æ‰€æœ‰Agentå·²å›åˆ°åˆå§‹ä½ç½®', 'success');
        }

        // åˆ·æ–°åœ°å›¾
        function refreshMap() {
            generateMap();
            showNotification('åœ°å›¾å·²åˆ·æ–°', 'success');
        }

        // æ¨¡æ‹Ÿä¸€æ­¥ - å¢å¼ºç‰ˆï¼Œè€ƒè™‘agentå…³ç³»å’Œäº¤äº’
        function simulateStep() {
            const events = [];
            const agentNames = Object.keys(gameData.agents);
            const activeAgents = agentNames.sort(() => 0.5 - Math.random()).slice(0, Math.min(4, agentNames.length));
            
            activeAgents.forEach(agentName => {
                const agent = gameData.agents[agentName];
                
                // åŸºäºå½“å‰çŠ¶æ€å’Œå…³ç³»çš„è¡Œä¸º
                const actions = [
                    `åœ¨${agent.location}${agent.mood}åœ°å·¥ä½œ`,
                    `è§‚å¯Ÿ${agent.location}çš„ç¯å¢ƒï¼Œæ€è€ƒäººç”Ÿ`,
                    `å†³å®šåšä¸€äº›æœ‰è¶£çš„äº‹æƒ…`,
                    `æ„Ÿåˆ°${agent.energy > 70 ? 'ç²¾åŠ›å……æ²›' : 'æœ‰äº›ç–²æƒ«'}`,
                    `å›å¿†èµ·ä¸æœ‹å‹ä»¬çš„ç¾å¥½æ—¶å…‰`,
                    `è®¡åˆ’ä¸‹æ¬¡ä¸åŒäº‹èšä¼š`,
                    `äº«å—å½“å‰çš„${agent.mood}çŠ¶æ€`
                ];
                
                const action = actions[Math.floor(Math.random() * actions.length)];
                events.push(`${agent.emoji} ${agentName}: ${action}`);
                
                // æ›´æ–°AgentçŠ¶æ€
                agent.energy = Math.max(10, Math.min(100, agent.energy + Math.floor(Math.random() * 21) - 10));
                
                // æ™ºèƒ½ç§»åŠ¨ï¼šè€ƒè™‘å…³ç³»å’Œåå¥½
                if (Math.random() < 0.3) {
                    let targetLocation = null;
                    
                    // æœ‰æ—¶ä¼šè·Ÿéšå…³ç³»å¥½çš„agent
                    if (Math.random() < 0.4 && agent.relationships) {
                        const bestFriends = Object.entries(agent.relationships)
                            .filter(([_, rel]) => rel.strength > 0.6)
                            .sort((a, b) => b[1].strength - a[1].strength);
                        
                        if (bestFriends.length > 0) {
                            const friendName = bestFriends[0][0];
                            const friendLocation = gameData.agents[friendName].location;
                            targetLocation = friendLocation;
                            events.push(`ğŸ’ ${agentName} æƒ³å»æ‰¾å¥½å‹ ${friendName}ï¼Œå‰å¾€ ${friendLocation}`);
                        }
                    }
                    
                    // å¦åˆ™éšæœºç§»åŠ¨
                    if (!targetLocation) {
                        const newBuilding = gameData.buildings[Math.floor(Math.random() * gameData.buildings.length)];
                        targetLocation = newBuilding.name;
                        const oldLocation = agent.location;
                        events.push(`ğŸš¶ ${agentName} ä» ${oldLocation} ç§»åŠ¨åˆ° ${newBuilding.name}`);
                    }
                    
                    // æ‰§è¡Œç§»åŠ¨
                    const building = gameData.buildings.find(b => b.name === targetLocation);
                    if (building) {
                        agent.x = building.x;
                        agent.y = building.y;
                        agent.location = building.name;
                        
                        // æ›´æ–°åœ°ç‚¹çƒ­åº¦
                        if (gameData.locationPopularity[targetLocation]) {
                            gameData.locationPopularity[targetLocation].visits = 
                                (gameData.locationPopularity[targetLocation].visits || 0) + 1;
                            gameData.locationPopularity[targetLocation].popularityScore += 0.05;
                        }
                    }
                }
                
                // æ›´æ–°å¿ƒæƒ…åŸºäºç¯å¢ƒå’Œå…³ç³»
                if (Math.random() < 0.2) {
                    const locationMoods = {
                        'å’–å•¡å…': ['æ”¾æ¾', 'æƒ¬æ„', 'ç¤¾äº¤'],
                        'å›¾ä¹¦é¦†': ['ä¸“æ³¨', 'å­¦ä¹ ', 'å®‰é™'],
                        'å…¬å›­': ['å¼€å¿ƒ', 'æ´»åŠ›', 'è‡ªç”±'],
                        'åŠå…¬å®¤': ['å¿™ç¢Œ', 'ä¸“ä¸š', 'æ•ˆç‡'],
                        'å®¶': ['èˆ’é€‚', 'å®‰å…¨', 'æ¸©æš–'],
                        'åŒ»é™¢': ['ä¸¥è‚ƒ', 'å…³æ€€', 'ä¸“ä¸š'],
                        'é¤å…': ['æ„‰å¿«', 'æ»¡è¶³', 'äº«å—'],
                        'ä¿®ç†åº—': ['ä¸“æ³¨', 'å®ç”¨', 'æˆå°±æ„Ÿ']
                    };
                    
                    const possibleMoods = locationMoods[agent.location] || ['å¹³é™', 'æ€è€ƒ', 'è§‚å¯Ÿ'];
                    agent.mood = possibleMoods[Math.floor(Math.random() * possibleMoods.length)];
                }
            });
            
            // æ£€æŸ¥åŒåœ°ç‚¹çš„agentsï¼Œå¯èƒ½è§¦å‘äº¤äº’
            const locationGroups = {};
            agentNames.forEach(name => {
                const agent = gameData.agents[name];
                const key = `${agent.x},${agent.y}`;
                if (!locationGroups[key]) {
                    locationGroups[key] = [];
                }
                locationGroups[key].push(name);
            });
            
            // å¦‚æœæœ‰å¤šä¸ªagentåœ¨åŒä¸€ä½ç½®ï¼Œå¯èƒ½ä¼šäº¤äº’
            Object.values(locationGroups).forEach(group => {
                if (group.length >= 2 && Math.random() < 0.3) { // 30%æ¦‚ç‡äº¤äº’
                    const location = gameData.agents[group[0]].location;
                    events.push(`ğŸ‘¥ ${group.join(', ')} åœ¨${location}ç›¸é‡äº†ï¼`);
                    
                    // å¦‚æœè‡ªåŠ¨äº¤äº’å¼€å¯ï¼Œè§¦å‘çœŸå®äº¤äº’
                    if (gameData.autoInteraction && Math.random() < 0.5) {
                        setTimeout(() => {
                            executeAgentInteraction(group.slice(0, 3)); // æœ€å¤š3ä¸ªagentäº¤äº’
                        }, 1000);
                    }
                }
            });
            
            // æ˜¾ç¤ºæ¨¡æ‹Ÿç»“æœ
            const outputDiv = document.getElementById('simulationOutput');
            outputDiv.innerHTML = `
                <div style="color: var(--primary); font-weight: 600; margin-bottom: 10px;">
                    <i class="fas fa-clock"></i> æ¨¡æ‹Ÿæ—¶é—´: ${new Date().toLocaleTimeString()}
                </div>
                ${events.map(event => `<div style="margin: 5px 0; padding: 5px 0; border-left: 3px solid var(--accent); padding-left: 10px;">${event}</div>`).join('')}
            `;
            
            // åˆ·æ–°æ˜¾ç¤º
            generateMap();
            generateAgentCards();
            showNotification(`æ™ºèƒ½æ¨¡æ‹Ÿå®Œæˆï¼Œ${activeAgents.length}ä¸ªAgentæ‰§è¡Œäº†åŠ¨ä½œ`, 'success');
        }

        // é”®ç›˜äº‹ä»¶
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && document.getElementById('messageInput') === document.activeElement) {
                sendMessage();
            }
            if (e.key === 'Escape') {
                clearChat();
            }
        });

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            initParticles();
            loadGameData(); // åŠ è½½ä¿å­˜çš„æ•°æ®
            initializeSocialNetwork(); // åˆå§‹åŒ–ç¤¾äº¤ç½‘ç»œ
            generateMap();
            generateAgentCards();
            
            // æ·»åŠ è¾“å…¥æ¡†äº‹ä»¶ç›‘å¬
            document.getElementById('messageInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            showNotification('AIè™šæ‹Ÿå°é•‡å·²å¯åŠ¨ï¼ç¤¾äº¤ç½‘ç»œå·²åˆå§‹åŒ–', 'success');
            
            // å®šæœŸè‡ªåŠ¨æ¨¡æ‹Ÿå’Œäº¤äº’
            setInterval(() => {
                if (Math.random() < 0.1) { // 10%æ¦‚ç‡è‡ªåŠ¨æ¨¡æ‹Ÿ
                    simulateStep();
                }
                
                // è‡ªåŠ¨agentäº¤äº’
                if (gameData.autoInteraction && Math.random() < 0.15) { // 15%æ¦‚ç‡è‡ªåŠ¨äº¤äº’
                    triggerAgentInteraction();
                }
                
                // æ™ºèƒ½ç§»åŠ¨
                if (Math.random() < 0.2) { // 20%æ¦‚ç‡æ™ºèƒ½ç§»åŠ¨
                    intelligentGroupMovement();
                    generateMap();
                    generateAgentCards();
                }
                
                // å…³ç³»è¡°å‡
                applyRelationshipDecay();
                
                // è‡ªåŠ¨ä¿å­˜æ•°æ®
                saveGameData();
                
            }, 20000); // æ¯20ç§’æ£€æŸ¥ä¸€æ¬¡
            
            // å®šæœŸæ›´æ–°åœ°ç‚¹çƒ­åº¦
            setInterval(() => {
                Object.entries(gameData.locationPopularity).forEach(([location, stats]) => {
                    const currentCount = Object.values(gameData.agents).filter(agent => agent.location === location).length;
                    gameData.locationPopularity[location].currentOccupants = currentCount;
                    gameData.locationPopularity[location].popularityScore = 
                        Math.max(0, stats.popularityScore - 0.01); // çƒ­åº¦ç¼“æ…¢è¡°å‡
                });
            }, 10000); // æ¯10ç§’æ›´æ–°çƒ­åº¦
            
            // å®šæœŸä¿å­˜æ•°æ®
            setInterval(() => {
                saveGameData();
            }, 60000); // æ¯åˆ†é’Ÿä¿å­˜ä¸€æ¬¡
        });

        // æ•°æ®æŒä¹…åŒ–ç³»ç»Ÿ
        function saveGameData() {
            try {
                const dataToSave = {
                    agents: gameData.agents,
                    socialNetwork: gameData.socialNetwork,
                    locationPopularity: gameData.locationPopularity,
                    agentInteractions: gameData.agentInteractions.slice(-100), // åªä¿å­˜æœ€è¿‘100æ¡
                    chatHistory: gameData.chatHistory.slice(-50), // åªä¿å­˜æœ€è¿‘50æ¡
                    systemTime: gameData.systemTime,
                    lastDecayTime: gameData.lastDecayTime
                };
                
                localStorage.setItem('aiTownData', JSON.stringify(dataToSave));
                console.log('æ¸¸æˆæ•°æ®å·²ä¿å­˜');
            } catch (error) {
                console.error('ä¿å­˜æ•°æ®å¤±è´¥:', error);
            }
        }

        function loadGameData() {
            try {
                const savedData = localStorage.getItem('aiTownData');
                if (savedData) {
                    const loadedData = JSON.parse(savedData);
                    
                    // æ¢å¤æ•°æ®
                    if (loadedData.agents) {
                        Object.assign(gameData.agents, loadedData.agents);
                    }
                    if (loadedData.socialNetwork) {
                        Object.assign(gameData.socialNetwork, loadedData.socialNetwork);
                    }
                    if (loadedData.locationPopularity) {
                        Object.assign(gameData.locationPopularity, loadedData.locationPopularity);
                    }
                    if (loadedData.agentInteractions) {
                        gameData.agentInteractions = loadedData.agentInteractions;
                    }
                    if (loadedData.chatHistory) {
                        gameData.chatHistory = loadedData.chatHistory;
                    }
                    if (loadedData.systemTime) {
                        gameData.systemTime = new Date(loadedData.systemTime);
                    }
                    if (loadedData.lastDecayTime) {
                        gameData.lastDecayTime = new Date(loadedData.lastDecayTime);
                    }
                    
                    console.log('æ¸¸æˆæ•°æ®å·²åŠ è½½');
                    showNotification('æ¸¸æˆæ•°æ®å·²æ¢å¤', 'success');
                }
            } catch (error) {
                console.error('åŠ è½½æ•°æ®å¤±è´¥:', error);
            }
        }

        // é«˜çº§ç»Ÿè®¡ç³»ç»Ÿ
        function getAdvancedStats() {
            const stats = {
                agents: {
                    total: Object.keys(gameData.agents).length,
                    byOccupation: {},
                    byLocation: {},
                    byMood: {},
                    avgEnergy: 0,
                    totalMemories: 0
                },
                relationships: {
                    total: 0,
                    byLevel: {},
                    avgStrength: 0,
                    totalInteractions: 0
                },
                locations: {
                    total: Object.keys(gameData.buildings).length,
                    byPopularity: [],
                    totalVisits: 0,
                    totalInteractions: 0
                },
                interactions: {
                    total: gameData.agentInteractions.length,
                    byType: {},
                    byLocation: {},
                    recent: gameData.agentInteractions.slice(-10)
                }
            };
            
            // Agentç»Ÿè®¡
            let totalEnergy = 0;
            Object.values(gameData.agents).forEach(agent => {
                // èŒä¸šç»Ÿè®¡
                stats.agents.byOccupation[agent.occupation] = 
                    (stats.agents.byOccupation[agent.occupation] || 0) + 1;
                
                // ä½ç½®ç»Ÿè®¡
                stats.agents.byLocation[agent.location] = 
                    (stats.agents.byLocation[agent.location] || 0) + 1;
                
                // å¿ƒæƒ…ç»Ÿè®¡
                stats.agents.byMood[agent.mood] = 
                    (stats.agents.byMood[agent.mood] || 0) + 1;
                
                totalEnergy += agent.energy;
                stats.agents.totalMemories += agent.memories.length;
            });
            stats.agents.avgEnergy = totalEnergy / stats.agents.total;
            
            // å…³ç³»ç»Ÿè®¡
            let totalStrength = 0;
            Object.values(gameData.agents).forEach(agent => {
                Object.values(agent.relationships).forEach(relationship => {
                    stats.relationships.total++;
                    stats.relationships.totalInteractions += relationship.interactions;
                    totalStrength += relationship.strength;
                    
                    stats.relationships.byLevel[relationship.relationshipLevel] = 
                        (stats.relationships.byLevel[relationship.relationshipLevel] || 0) + 1;
                });
            });
            stats.relationships.avgStrength = totalStrength / stats.relationships.total;
            
            // åœ°ç‚¹ç»Ÿè®¡
            let totalVisits = 0;
            let totalLocationInteractions = 0;
            Object.entries(gameData.locationPopularity).forEach(([location, data]) => {
                totalVisits += data.visits || 0;
                totalLocationInteractions += data.interactions || 0;
                
                stats.locations.byPopularity.push({
                    location: location,
                    popularity: data.popularityScore,
                    visits: data.visits,
                    interactions: data.interactions,
                    currentOccupants: data.currentOccupants
                });
            });
            stats.locations.totalVisits = totalVisits;
            stats.locations.totalInteractions = totalLocationInteractions;
            
            // äº¤äº’ç»Ÿè®¡
            gameData.agentInteractions.forEach(interaction => {
                stats.interactions.byType[interaction.type] = 
                    (stats.interactions.byType[interaction.type] || 0) + 1;
                stats.interactions.byLocation[interaction.location] = 
                    (stats.interactions.byLocation[interaction.location] || 0) + 1;
            });
            
            // æ’åº
            stats.locations.byPopularity.sort((a, b) => b.popularity - a.popularity);
            
            return stats;
        }

        // æ˜¾ç¤ºé«˜çº§ç»Ÿè®¡
        function showAdvancedStats() {
            const stats = getAdvancedStats();
            let statsText = "ğŸ“Š é«˜çº§ç»Ÿè®¡åˆ†æ\n\n";
            
            // Agentç»Ÿè®¡
            statsText += "ğŸ‘¥ Agentç»Ÿè®¡:\n";
            statsText += `  æ€»æ•°é‡: ${stats.agents.total}\n`;
            statsText += `  å¹³å‡èƒ½é‡: ${stats.agents.avgEnergy.toFixed(1)}%\n`;
            statsText += `  æ€»è®°å¿†æ•°: ${stats.agents.totalMemories}\n\n`;
            
            statsText += "ğŸ’¼ èŒä¸šåˆ†å¸ƒ:\n";
            Object.entries(stats.agents.byOccupation).forEach(([occupation, count]) => {
                statsText += `  ${occupation}: ${count} äºº\n`;
            });
            statsText += "\n";
            
            // å…³ç³»ç»Ÿè®¡
            statsText += "â¤ï¸ å…³ç³»ç»Ÿè®¡:\n";
            statsText += `  æ€»å…³ç³»æ•°: ${stats.relationships.total}\n`;
            statsText += `  å¹³å‡å¼ºåº¦: ${(stats.relationships.avgStrength * 100).toFixed(1)}%\n`;
            statsText += `  æ€»äº¤äº’æ•°: ${stats.relationships.totalInteractions}\n\n`;
            
            statsText += "ğŸ“ˆ å…³ç³»ç­‰çº§åˆ†å¸ƒ:\n";
            Object.entries(stats.relationships.byLevel).forEach(([level, count]) => {
                statsText += `  ${level}: ${count} ä¸ª\n`;
            });
            statsText += "\n";
            
            // åœ°ç‚¹ç»Ÿè®¡
            statsText += "ğŸ“ åœ°ç‚¹ç»Ÿè®¡:\n";
            statsText += `  æ€»åœ°ç‚¹æ•°: ${stats.locations.total}\n`;
            statsText += `  æ€»è®¿é—®æ•°: ${stats.locations.totalVisits}\n`;
            statsText += `  æ€»äº¤äº’æ•°: ${stats.locations.totalInteractions}\n\n`;
            
            statsText += "ğŸ”¥ çƒ­é—¨åœ°ç‚¹æ’è¡Œ:\n";
            stats.locations.byPopularity.slice(0, 5).forEach((loc, index) => {
                statsText += `  ${loc.location}: ${loc.popularity.toFixed(1)}åˆ†\n`;
            });
            statsText += "\n";
            
            // äº¤äº’ç»Ÿè®¡
            statsText += "ğŸ’¬ äº¤äº’ç»Ÿè®¡:\n";
            statsText += `  æ€»äº¤äº’æ•°: ${stats.interactions.total}\n\n`;
            
            statsText += "ğŸ¯ äº¤äº’ç±»å‹åˆ†å¸ƒ:\n";
            Object.entries(stats.interactions.byType).forEach(([type, count]) => {
                statsText += `  ${type}: ${count} æ¬¡\n`;
            });
            
            alert(statsText);
        }

        // æ™ºèƒ½ç§»åŠ¨ç³»ç»Ÿ
        function intelligentAgentMovement(agentName) {
            const agent = gameData.agents[agentName];
            const currentLocation = agent.location;
            
            // ç§»åŠ¨æ¦‚ç‡ï¼š30%æ¦‚ç‡ç§»åŠ¨
            if (Math.random() > 0.3) {
                return null;
            }
            
            let targetLocation = null;
            let moveReason = '';
            
            // ç­–ç•¥1ï¼šè·Ÿéšå…³ç³»å¥½çš„æœ‹å‹
            if (Math.random() < 0.4 && agent.relationships) {
                const bestFriends = Object.entries(agent.relationships)
                    .filter(([_, rel]) => rel.strength > 0.6)
                    .sort((a, b) => b[1].strength - a[1].strength);
                
                if (bestFriends.length > 0) {
                    const friendName = bestFriends[0][0];
                    const friendLocation = gameData.agents[friendName].location;
                    
                    if (friendLocation !== currentLocation) {
                        targetLocation = friendLocation;
                        moveReason = `æƒ³å»æ‰¾å¥½å‹ ${friendName}`;
                    }
                }
            }
            
            // ç­–ç•¥2ï¼šåŸºäºèŒä¸šåå¥½
            if (!targetLocation && Math.random() < 0.3) {
                const preferredLocations = agent.preferences.filter(loc => loc !== currentLocation);
                if (preferredLocations.length > 0) {
                    targetLocation = preferredLocations[Math.floor(Math.random() * preferredLocations.length)];
                    moveReason = `èŒä¸šåå¥½`;
                }
            }
            
            // ç­–ç•¥3ï¼šæ¢ç´¢æ–°åœ°ç‚¹
            if (!targetLocation && Math.random() < 0.2) {
                const unvisitedLocations = Object.keys(gameData.buildings).filter(loc => 
                    loc !== currentLocation && !agent.memories.some(m => m.location === loc)
                );
                
                if (unvisitedLocations.length > 0) {
                    targetLocation = unvisitedLocations[Math.floor(Math.random() * unvisitedLocations.length)];
                    moveReason = `æ¢ç´¢æ–°åœ°ç‚¹`;
                }
            }
            
            // ç­–ç•¥4ï¼šéšæœºç§»åŠ¨
            if (!targetLocation) {
                const allLocations = Object.keys(gameData.buildings);
                const otherLocations = allLocations.filter(loc => loc !== currentLocation);
                targetLocation = otherLocations[Math.floor(Math.random() * otherLocations.length)];
                moveReason = `éšæœºç§»åŠ¨`;
            }
            
            // æ‰§è¡Œç§»åŠ¨
            if (targetLocation && targetLocation !== currentLocation) {
                const building = gameData.buildings.find(b => b.name === targetLocation);
                if (building) {
                    const oldLocation = agent.location;
                    agent.x = building.x;
                    agent.y = building.y;
                    agent.location = targetLocation;
                    
                    // æ›´æ–°åœ°ç‚¹çƒ­åº¦
                    if (gameData.locationPopularity[targetLocation]) {
                        gameData.locationPopularity[targetLocation].visits = 
                            (gameData.locationPopularity[targetLocation].visits || 0) + 1;
                        gameData.locationPopularity[targetLocation].popularityScore += 0.05;
                        gameData.locationPopularity[targetLocation].lastActivity = new Date();
                    }
                    
                    // è®°å½•ç§»åŠ¨è®°å¿†
                    agent.memories.push({
                        type: 'movement',
                        from: oldLocation,
                        to: targetLocation,
                        reason: moveReason,
                        timestamp: new Date().toISOString()
                    });
                    
                    // é™åˆ¶è®°å¿†æ•°é‡
                    if (agent.memories.length > 50) {
                        agent.memories = agent.memories.slice(-50);
                    }
                    
                    // æ›´æ–°å¿ƒæƒ…åŸºäºæ–°åœ°ç‚¹
                    updateAgentMood(agentName, targetLocation);
                    
                    return {
                        from: oldLocation,
                        to: targetLocation,
                        reason: moveReason
                    };
                }
            }
            
            return null;
        }

        // æ›´æ–°Agentå¿ƒæƒ…
        function updateAgentMood(agentName, location) {
            const agent = gameData.agents[agentName];
            
            const locationMoods = {
                'å’–å•¡å…': ['æ”¾æ¾', 'æƒ¬æ„', 'ç¤¾äº¤', 'æ€è€ƒ'],
                'å›¾ä¹¦é¦†': ['ä¸“æ³¨', 'å­¦ä¹ ', 'å®‰é™', 'æ±‚çŸ¥'],
                'å…¬å›­': ['å¼€å¿ƒ', 'æ´»åŠ›', 'è‡ªç”±', 'æ”¾æ¾'],
                'åŠå…¬å®¤': ['å¿™ç¢Œ', 'ä¸“ä¸š', 'æ•ˆç‡', 'ä¸“æ³¨'],
                'å®¶': ['èˆ’é€‚', 'å®‰å…¨', 'æ¸©æš–', 'æ”¾æ¾'],
                'åŒ»é™¢': ['ä¸¥è‚ƒ', 'å…³æ€€', 'ä¸“ä¸š', 'ä¸“æ³¨'],
                'é¤å…': ['æ„‰å¿«', 'æ»¡è¶³', 'äº«å—', 'ç¤¾äº¤'],
                'ä¿®ç†åº—': ['ä¸“æ³¨', 'å®ç”¨', 'æˆå°±æ„Ÿ', 'å¿™ç¢Œ']
            };
            
            const possibleMoods = locationMoods[location] || ['å¹³é™', 'æ€è€ƒ', 'è§‚å¯Ÿ'];
            const newMood = possibleMoods[Math.floor(Math.random() * possibleMoods.length)];
            
            // 70%æ¦‚ç‡æ”¹å˜å¿ƒæƒ…
            if (Math.random() < 0.7) {
                agent.mood = newMood;
            }
            
            // èƒ½é‡å˜åŒ–
            const energyChange = Math.floor(Math.random() * 11) - 5; // -5 åˆ° +5
            agent.energy = Math.max(10, Math.min(100, agent.energy + energyChange));
        }

        // æ™ºèƒ½ç¾¤ä½“ç§»åŠ¨
        function intelligentGroupMovement() {
            const agentNames = Object.keys(gameData.agents);
            const movedAgents = [];
            
            agentNames.forEach(agentName => {
                const movement = intelligentAgentMovement(agentName);
                if (movement) {
                    movedAgents.push({
                        agent: agentName,
                        ...movement
                    });
                }
            });
            
            return movedAgents;
        }

        // åŸºäºå…³ç³»çš„æ¨èç§»åŠ¨
        function getRecommendedLocations(agentName) {
            const agent = gameData.agents[agentName];
            const recommendations = [];
            
            // åŸºäºæœ‹å‹ä½ç½®æ¨è
            Object.entries(agent.relationships).forEach(([friendName, relationship]) => {
                if (relationship.strength > 0.5) {
                    const friendLocation = gameData.agents[friendName].location;
                    if (friendLocation !== agent.location) {
                        recommendations.push({
                            location: friendLocation,
                            reason: `å¥½å‹ ${friendName} åœ¨æ­¤`,
                            priority: relationship.strength
                        });
                    }
                }
            });
            
            // åŸºäºèŒä¸šåå¥½æ¨è
            agent.preferences.forEach(pref => {
                if (pref !== agent.location) {
                    recommendations.push({
                        location: pref,
                        reason: 'èŒä¸šåå¥½',
                        priority: 0.6
                    });
                }
            });
            
            // åŸºäºåœ°ç‚¹çƒ­åº¦æ¨è
            Object.entries(gameData.locationPopularity).forEach(([location, stats]) => {
                if (location !== agent.location && stats.popularityScore > 60) {
                    recommendations.push({
                        location: location,
                        reason: 'çƒ­é—¨åœ°ç‚¹',
                        priority: stats.popularityScore / 100
                    });
                }
            });
            
            // æŒ‰ä¼˜å…ˆçº§æ’åº
            return recommendations.sort((a, b) => b.priority - a.priority);
        }

        // æ•°æ®å¯¼å‡ºåŠŸèƒ½
        function exportGameData() {
            try {
                const exportData = {
                    exportTime: new Date().toISOString(),
                    version: '3.0',
                    agents: gameData.agents,
                    socialNetwork: gameData.socialNetwork,
                    locationPopularity: gameData.locationPopularity,
                    agentInteractions: gameData.agentInteractions,
                    chatHistory: gameData.chatHistory,
                    systemTime: gameData.systemTime,
                    lastDecayTime: gameData.lastDecayTime
                };
                
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `ai_town_data_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                showNotification('æ¸¸æˆæ•°æ®å·²å¯¼å‡º', 'success');
            } catch (error) {
                console.error('å¯¼å‡ºæ•°æ®å¤±è´¥:', error);
                showNotification('å¯¼å‡ºæ•°æ®å¤±è´¥', 'error');
            }
        }

        // é‡ç½®æ¸¸æˆæ•°æ®
        function resetGameData() {
            if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰æ¸¸æˆæ•°æ®å—ï¼Ÿè¿™å°†æ¸…é™¤æ‰€æœ‰Agentå…³ç³»ã€äº¤äº’å†å²å’ŒèŠå¤©è®°å½•ã€‚')) {
                try {
                    // æ¸…é™¤æœ¬åœ°å­˜å‚¨
                    localStorage.removeItem('aiTownData');
                    
                    // é‡ç½®æ¸¸æˆæ•°æ®
                    gameData.agentInteractions = [];
                    gameData.chatHistory = [];
                    gameData.systemTime = new Date();
                    gameData.lastDecayTime = new Date();
                    
                    // é‡æ–°åˆå§‹åŒ–ç¤¾äº¤ç½‘ç»œ
                    initializeSocialNetwork();
                    
                    // é‡ç½®Agentä½ç½®
                    resetAgents();
                    
                    // æ¸…ç©ºäº¤äº’å†å²æ˜¾ç¤º
                    clearInteractionHistory();
                    
                    // æ¸…ç©ºèŠå¤©è®°å½•
                    clearChat();
                    
                    // åˆ·æ–°æ˜¾ç¤º
                    generateMap();
                    generateAgentCards();
                    
                    showNotification('æ¸¸æˆæ•°æ®å·²é‡ç½®', 'success');
                } catch (error) {
                    console.error('é‡ç½®æ•°æ®å¤±è´¥:', error);
                    showNotification('é‡ç½®æ•°æ®å¤±è´¥', 'error');
                }
            }
        }

        // æ˜¾ç¤ºå…³ç³»è¡°å‡ä¿¡æ¯
        function showDecayInfo() {
            const now = new Date();
            const timeDiff = now - gameData.lastDecayTime;
            const minutesSinceDecay = Math.floor(timeDiff / (1000 * 60));
            
            let decayText = `ğŸ“Š å…³ç³»è¡°å‡ä¿¡æ¯\n\n`;
            decayText += `ä¸Šæ¬¡è¡°å‡æ—¶é—´: ${gameData.lastDecayTime.toLocaleString()}\n`;
            decayText += `è·ç¦»ä¸‹æ¬¡è¡°å‡: ${Math.max(0, 30 - minutesSinceDecay)} åˆ†é’Ÿ\n`;
            decayText += `è¡°å‡é—´éš”: 30 åˆ†é’Ÿ\n\n`;
            
            // ç»Ÿè®¡å…³ç³»å˜åŒ–
            let strongRelationships = 0;
            let weakRelationships = 0;
            let totalRelationships = 0;
            
            Object.values(gameData.agents).forEach(agent => {
                Object.values(agent.relationships).forEach(relationship => {
                    totalRelationships++;
                    if (relationship.strength > 0.6) {
                        strongRelationships++;
                    } else if (relationship.strength < 0.3) {
                        weakRelationships++;
                    }
                });
            });
            
            decayText += `å…³ç³»ç»Ÿè®¡:\n`;
            decayText += `  æ€»å…³ç³»æ•°: ${totalRelationships}\n`;
            decayText += `  å¼ºå…³ç³» (>60%): ${strongRelationships}\n`;
            decayText += `  å¼±å…³ç³» (<30%): ${weakRelationships}\n`;
            decayText += `  ä¸­ç­‰å…³ç³»: ${totalRelationships - strongRelationships - weakRelationships}\n`;
            
            alert(decayText);
        }
    </script>
</body>
</html>
